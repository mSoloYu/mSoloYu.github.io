<!doctype html>
<html class="theme-next use-motion theme-next-next">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>




  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.0"/>


    <meta name="description" content="关注切入点、产品、设计开发和敏捷实践" />




    <meta name="keywords" content="Golang, Android, Reading, Thinking" />





    <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.0" />




  <title> mSolo </title>
</head>

<body>
  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">mSolo</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>


  <ul id="menu" class="menu">
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          首页
        </a>
      </li>
    
      
      <li class="menu-item menu-item-projects">
        <a href="/projects">
          <i class="menu-item-icon icon-projects"></i> <br />
          menu.projects
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          归档
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          标签
        </a>
      </li>
    
      
      <li class="menu-item menu-item-about">
        <a href="/about">
          <i class="menu-item-icon icon-about"></i> <br />
          关于
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
            
          

          <div id="posts" class="posts-expand">
            
  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/24/android-ipc/">
                Android IPC (上)
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          
            发表于 2015-03-24
          
        </span>

        
          
            <span class="post-category">
              &nbsp; | &nbsp; 分类于
              
                <a href="/categories/Android/">Android</a>

                
                

              
            </span>
          
        

        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          
            <blockquote>
<p>IPC is a framework for the exchange of signals and data across multiple processes.</p>
</blockquote>
<h3 id="Parcel">Parcel</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomData</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;CustomData&gt; CREATOR = <span class="keyword">new</span> Parcelable.Creator&lt;CustomData&gt;() &#123;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> CustomData <span class="title">createFromParcel</span><span class="params">(Parcel parcel)</span> </span>&#123;</span><br><span class="line">            CustomData customData = <span class="keyword">new</span> CustomData();</span><br><span class="line">            customData.mName = parcel.readString();</span><br><span class="line">            customData.mReferences = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">            parcel.readStringList(customData.mReferences);</span><br><span class="line">            customData.mCreated = <span class="keyword">new</span> Date(parcel.readLong());</span><br><span class="line">            <span class="keyword">return</span> customData;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">public</span> CustomData[] newArray(<span class="keyword">int</span> size) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CustomData[size];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">private</span> String mName;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; mReferences;</span><br><span class="line">    <span class="keyword">private</span> Date mCreated;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mName = “”;</span><br><span class="line">        mReferences = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        mCreated = <span class="keyword">new</span> Date();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel parcel, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        parcel.writeString(mName);</span><br><span class="line">        parcel.writeStringList(mReferences);</span><br><span class="line">        parcel.writeLong(mCreated.getTime());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        CustomData that = (CustomData) o;</span><br><span class="line">        <span class="keyword">return</span> mCreated.equals(that.mCreated) &amp;&amp; mName.equals(that.mName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = mName.hashCode();</span><br><span class="line">        result = <span class="number">31</span> * result + mCreated.hashCode();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
            <div class="post-more-link text-center">
              <a class="btn" href="/2015/03/24/android-ipc/#more">
                阅读全文 &raquo;
              </a>
            </div>
          
        
      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Android/">
                #Android
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/23/android-recycleview-study/">
                Android 中的 RecyclerView
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          
            发表于 2015-03-23
          
        </span>

        
          
            <span class="post-category">
              &nbsp; | &nbsp; 分类于
              
                <a href="/categories/Android/">Android</a>

                
                

              
            </span>
          
        

        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          
            <h3 id="RecyclerView是什么?">RecyclerView是什么?</h3><ul>
<li>一种新的视图组，目标是为任何基于适配器的视图提供相似的渲染方式。它被作为ListView和GridView控件的继承者，在最新的support-V7版本中提供支持。</li>
<li>如果使用RecyclerView，你需要了解以下三个元素：<ul>
<li>RecyclerView.Adapter</li>
<li>LayoutManager</li>
<li>ItemAnimator</li>
</ul>
</li>
</ul>
<h3 id="RecyclerView-Adapter">RecyclerView.Adapter</h3><ul>
<li>RecyclerView包含了一种新型适配器。它与现在使用的适配器类似，但也稍有不同，例如它需要使用ViewHolder。使用时需要重写两个主要方法：一个用来展现视图和它的持有者，而另一个用来把数据绑定到视图上。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRecyclerAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">MyRecyclerAdapter</span>.<span class="title">ViewHolder</span>&gt; </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> List&lt;ViewModel&gt; items;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> itemLayout;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRecyclerAdapter</span><span class="params">(List&lt;ViewModel&gt; items, <span class="keyword">int</span> itemLayout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.items = items;</span><br><span class="line">        <span class="keyword">this</span>.itemLayout = itemLayout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span> <span class="function"><span class="keyword">public</span> ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</span><br><span class="line">        View v = LayoutInflater.from(parent.getContext()).inflate(itemLayout, parent, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ViewHolder(v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(ViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        ViewModel item = items.get(position);</span><br><span class="line">        holder.text.setText(item.getText());</span><br><span class="line">        holder.image.setImageBitmap(<span class="keyword">null</span>);</span><br><span class="line">        Picasso.with(holder.image.getContext()).cancelRequest(holder.image);</span><br><span class="line">        Picasso.with(holder.image.getContext()).load(item.getImage()).into(holder.image);</span><br><span class="line">        holder.itemView.setTag(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> items.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(ViewModel item, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        items.add(position, item);</span><br><span class="line">        notifyItemInserted(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(ViewModel item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> position = items.indexOf(item);</span><br><span class="line">        items.remove(position);</span><br><span class="line">        notifyItemRemoved(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> ImageView image;</span><br><span class="line">        <span class="keyword">public</span> TextView text;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ViewHolder</span><span class="params">(View itemView)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(itemView);</span><br><span class="line">            image = (ImageView) itemView.findViewById(R.id.image);</span><br><span class="line">            text = (TextView) itemView.findViewById(R.id.text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="LayoutManager">LayoutManager</h3><ul>
<li>这个类决定视图被放在画面中哪个位置，但这只是它的众多职责之一。它可以管理滚动和循环利用。</li>
</ul>
<h3 id="ItemAnimator">ItemAnimator</h3><ul>
<li>ItemAnimator会根据适配器上收到的通知动画显示视图组的修改。基本上，它会自动显示添加和移除条目动画。</li>
</ul>
<h3 id="RecyclerView设置">RecyclerView设置</h3><ul>
<li>初始化一个运行的RecyclerView<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RecyclerView recyclerView = (RecyclerView) findViewById(R.id.list);</span><br><span class="line">recyclerView.setHasFixedSize(<span class="keyword">true</span>);    <span class="comment">// 使RecyclerView保持固定的大小，该信息被用于自身的优化</span></span><br><span class="line">recyclerView.setAdapter(<span class="keyword">new</span> MyRecyclerAdapter(createMockList(), R.layout.item));</span><br><span class="line">recyclerView.setLayoutManager(<span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>));</span><br><span class="line">recyclerView.setItemAnimator(<span class="keyword">new</span> DefaultItemAnimator());</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="示例">示例</h3><ul>
<li><p>code</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleRecyclerActivity</span> <span class="keyword">extends</span> <span class="title">ActionBarActivity</span> <span class="keyword">implements</span></span><br><span class="line">        <span class="title">SimpleItemAdapter</span>.<span class="title">OnItemClickListener</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> RecyclerView mRecyclerView;</span><br><span class="line">    <span class="keyword">private</span> SimpleItemAdapter mAdapter;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Layout Managers */</span></span><br><span class="line">    <span class="keyword">private</span> LinearLayoutManager mHorizontalManager;</span><br><span class="line">    <span class="keyword">private</span> LinearLayoutManager mVerticalManager;</span><br><span class="line">    <span class="keyword">private</span> GridLayoutManager mVerticalGridManager;</span><br><span class="line">    <span class="keyword">private</span> GridLayoutManager mHorizontalGridManager;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Decorations */</span></span><br><span class="line">    <span class="keyword">private</span> ConnectorDecoration mConnectors;</span><br><span class="line"> </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"> </span><br><span class="line">        mRecyclerView = <span class="keyword">new</span> RecyclerView(<span class="keyword">this</span>);</span><br><span class="line">        mHorizontalManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>,</span><br><span class="line">                LinearLayoutManager.HORIZONTAL, <span class="keyword">false</span>);</span><br><span class="line">        mVerticalManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>,</span><br><span class="line">                LinearLayoutManager.VERTICAL, <span class="keyword">false</span>);</span><br><span class="line">        mVerticalGridManager = <span class="keyword">new</span> GridLayoutManager(<span class="keyword">this</span>,</span><br><span class="line">                <span class="number">2</span>, <span class="comment">/* Number of grid columns */</span></span><br><span class="line">                LinearLayoutManager.VERTICAL, <span class="comment">/* Orient grid vertically */</span></span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line">        mHorizontalGridManager = <span class="keyword">new</span> GridLayoutManager(<span class="keyword">this</span>,</span><br><span class="line">                <span class="number">3</span>, <span class="comment">/* Number of grid rows */</span></span><br><span class="line">                LinearLayoutManager.HORIZONTAL, <span class="comment">/* Orient grid horizontally */</span></span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//Connector line decorations for vertical grid</span></span><br><span class="line">        mConnectors = <span class="keyword">new</span> ConnectorDecoration(<span class="keyword">this</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//Stagger the vertical grid</span></span><br><span class="line">        mVerticalGridManager.setSpanSizeLookup(<span class="keyword">new</span> GridStaggerLookup());</span><br><span class="line"> </span><br><span class="line">        mAdapter = <span class="keyword">new</span> SimpleItemAdapter(<span class="keyword">this</span>);</span><br><span class="line">        mAdapter.setOnItemClickListener(<span class="keyword">this</span>);</span><br><span class="line">        mRecyclerView.setAdapter(mAdapter);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//Apply margins decoration to all collections</span></span><br><span class="line">        mRecyclerView.addItemDecoration(<span class="keyword">new</span> InsetDecoration(<span class="keyword">this</span>));</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//Default to vertical layout</span></span><br><span class="line">        selectLayoutManager(R.id.action_vertical);</span><br><span class="line">        setContentView(mRecyclerView);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">        getMenuInflater().inflate(R.menu.layout_options, menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> selectLayoutManager(item.getItemId());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">selectLayoutManager</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (id) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.action_vertical:</span><br><span class="line">                mRecyclerView.setLayoutManager(mVerticalManager);</span><br><span class="line">                mRecyclerView.removeItemDecoration(mConnectors);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.action_horizontal:</span><br><span class="line">                mRecyclerView.setLayoutManager(mHorizontalManager);</span><br><span class="line">                mRecyclerView.removeItemDecoration(mConnectors);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.action_grid_vertical:</span><br><span class="line">                mRecyclerView.setLayoutManager(mVerticalGridManager);</span><br><span class="line">                mRecyclerView.addItemDecoration(mConnectors);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.action_grid_horizontal:</span><br><span class="line">                mRecyclerView.setLayoutManager(mHorizontalGridManager);</span><br><span class="line">                mRecyclerView.removeItemDecoration(mConnectors);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.action_add_item:</span><br><span class="line">                <span class="comment">//Insert a new item</span></span><br><span class="line">                mAdapter.insertItemAtIndex(<span class="string">"Android Recipes"</span>, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.action_remove_item:</span><br><span class="line">                <span class="comment">//Remove the first item</span></span><br><span class="line">                mAdapter.removeItemAtIndex(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="javadoc">/** OnItemClickListener Methods */</span></span><br><span class="line"> </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(SimpleItemAdapter.ItemHolder item, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, item.getSummary(), Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>res/menu/layout_options.xml</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;menu xmlns:android="http://schemas.android.com/apk/res/android"</span><br><span class="line">    xmlns:app="http://schemas.android.com/apk/res-auto"&gt;</span><br><span class="line">    &lt;item</span><br><span class="line">        android:id="@+id/action_add_item"</span><br><span class="line">        android:title="Add Item"</span><br><span class="line">        android:icon="@android:drawable/ic_menu_add"</span><br><span class="line">        app:showAsAction="ifRoom" /&gt;</span><br><span class="line">    &lt;item</span><br><span class="line">        android:id="@+id/action_remove_item"</span><br><span class="line">        android:title="Remove Item"</span><br><span class="line">        android:icon="@android:drawable/ic_menu_delete"</span><br><span class="line">        app:showAsAction="ifRoom" /&gt;</span><br><span class="line">    &lt;item</span><br><span class="line">        android:id="@+id/action_vertical"</span><br><span class="line">        android:title="Vertical List"</span><br><span class="line">        app:showAsAction="never"/&gt;</span><br><span class="line">    &lt;item</span><br><span class="line">        android:id="@+id/action_horizontal"</span><br><span class="line">        android:title="Horizontal List"</span><br><span class="line">        app:showAsAction="never"/&gt;</span><br><span class="line">    &lt;item</span><br><span class="line">        android:id="@+id/action_grid_vertical"</span><br><span class="line">        android:title="Vertical Grid"</span><br><span class="line">        app:showAsAction="never"/&gt;</span><br><span class="line">    &lt;item</span><br><span class="line">        android:id="@+id/action_grid_horizontal"</span><br><span class="line">        android:title="Horizontal Grid"</span><br><span class="line">        app:showAsAction="never"/&gt;</span><br><span class="line">&lt;/menu&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>res/layout/collection_item.xml</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line">&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"</span><br><span class="line">    android:layout_width="match_parent"</span><br><span class="line">    android:layout_height="wrap_content"</span><br><span class="line">    android:orientation="vertical"</span><br><span class="line">    android:padding="8dp"</span><br><span class="line">    android:background="#CCF"&gt;</span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id="@+id/text_title"</span><br><span class="line">        android:layout_width="wrap_content"</span><br><span class="line">        android:layout_height="wrap_content"</span><br><span class="line">        android:textAppearance="?android:textAppearanceLarge"/&gt;</span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id="@+id/text_summary"</span><br><span class="line">        android:layout_width="wrap_content"</span><br><span class="line">        android:layout_height="wrap_content"</span><br><span class="line">        android:textAppearance="?android:textAppearanceMedium"/&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Adapter Implementation for RecyclerView</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleItemAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">SimpleItemAdapter</span>.<span class="title">ItemHolder</span>&gt; </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Click handler interface. RecyclerView does not have</span><br><span class="line">     * its own built in like AdapterViews do.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnItemClickListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(ItemHolder item, <span class="keyword">int</span> position)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] ITEMS = &#123;</span><br><span class="line">            <span class="string">"Apples"</span>, <span class="string">"Oranges"</span>, <span class="string">"Bananas"</span>, <span class="string">"Mangos"</span>,</span><br><span class="line">            <span class="string">"Carrots"</span>, <span class="string">"Peas"</span>, <span class="string">"Broccoli"</span>,</span><br><span class="line">            <span class="string">"Pork"</span>, <span class="string">"Chicken"</span>, <span class="string">"Beef"</span>, <span class="string">"Lamb"</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; mItems;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> OnItemClickListener mOnItemClickListener;</span><br><span class="line">    <span class="keyword">private</span> LayoutInflater mLayoutInflater;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleItemAdapter</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mLayoutInflater = LayoutInflater.from(context);</span><br><span class="line">        <span class="comment">//Create static list of dummy items</span></span><br><span class="line">        mItems = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        mItems.addAll(Arrays.asList(ITEMS));</span><br><span class="line">        mItems.addAll(Arrays.asList(ITEMS));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ItemHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</span><br><span class="line">        View itemView = mLayoutInflater.inflate(R.layout.collection_item, parent, <span class="keyword">false</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ItemHolder(itemView, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(ItemHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        holder.setTitle(<span class="string">"Item #"</span>+(position+<span class="number">1</span>));</span><br><span class="line">        holder.setSummary(mItems.get(position));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mItems.size();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> OnItemClickListener <span class="title">getOnItemClickListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mOnItemClickListener;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnItemClickListener</span><span class="params">(OnItemClickListener listener)</span> </span>&#123;</span><br><span class="line">        mOnItemClickListener = listener;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Methods to manage modifying the data set */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertItemAtIndex</span><span class="params">(String item, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        mItems.add(position, item);</span><br><span class="line">        <span class="comment">//Notify the view to trigger a change animation</span></span><br><span class="line">        notifyItemInserted(position);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeItemAtIndex</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (position &gt;= mItems.size()) <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">        mItems.remove(position);</span><br><span class="line">        <span class="comment">//Notify the view to trigger a change animation</span></span><br><span class="line">        notifyItemRemoved(position);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Required implementation of ViewHolder to wrap item view */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> <span class="keyword">implements</span></span><br><span class="line">            <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> SimpleItemAdapter mParent;</span><br><span class="line">        <span class="keyword">private</span> TextView mTitleView, mSummaryView;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ItemHolder</span><span class="params">(View itemView, SimpleItemAdapter parent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(itemView);</span><br><span class="line">            itemView.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">            mParent = parent;</span><br><span class="line"> </span><br><span class="line">            mTitleView = (TextView) itemView.findViewById(R.id.text_title);</span><br><span class="line">            mSummaryView = (TextView) itemView.findViewById(R.id.text_summary);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(CharSequence title)</span> </span>&#123;</span><br><span class="line">            mTitleView.setText(title);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSummary</span><span class="params">(CharSequence summary)</span> </span>&#123;</span><br><span class="line">            mSummaryView.setText(summary);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> CharSequence <span class="title">getSummary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> mSummaryView.getText();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> OnItemClickListener listener = mParent.getOnItemClickListener();</span><br><span class="line">            <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                listener.onItemClick(<span class="keyword">this</span>, getPosition());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Staggered Grid SpanSizeLookup</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GridStaggerLookup</span> <span class="keyword">extends</span> <span class="title">GridLayoutManager</span>.<span class="title">SpanSizeLookup</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSpanSize</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (position % <span class="number">3</span> == <span class="number">0</span> ? <span class="number">2</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ItemDecoration Providing Inset Margins</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InsetDecoration</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ItemDecoration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mInsetMargin;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InsetDecoration</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        mInsetMargin = context.getResources()</span><br><span class="line">                .getDimensionPixelOffset(R.dimen.inset_margin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getItemOffsets</span><span class="params">(Rect outRect, View view, RecyclerView parent,</span><br><span class="line">            RecyclerView.State state)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Apply the calculated margin to all four edges of the child view</span></span><br><span class="line">        outRect.set(mInsetMargin, mInsetMargin, mInsetMargin, mInsetMargin);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ItemDecoration Providing Connecting Lines</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectorDecoration</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ItemDecoration</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> Paint mLinePaint;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mLineLength;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConnectorDecoration</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        mLineLength = context.getResources()</span><br><span class="line">                .getDimensionPixelOffset(R.dimen.inset_margin);</span><br><span class="line">        <span class="keyword">int</span> connectorStroke = context.getResources()</span><br><span class="line">                .getDimensionPixelSize(R.dimen.connector_stroke);</span><br><span class="line"> </span><br><span class="line">        mLinePaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</span><br><span class="line">        mLinePaint.setColor(Color.BLACK);</span><br><span class="line">        mLinePaint.setStyle(Paint.Style.STROKE);</span><br><span class="line">        mLinePaint.setStrokeWidth(connectorStroke);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas c, RecyclerView parent, RecyclerView.State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> RecyclerView.LayoutManager manager = parent.getLayoutManager();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; parent.getChildCount(); i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> View child = parent.getChildAt(i);</span><br><span class="line">            <span class="keyword">boolean</span> isLarge = parent.getChildViewHolder(child).getPosition() % <span class="number">3</span> == <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (!isLarge) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childLeft = manager.getDecoratedLeft(child);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childRight = manager.getDecoratedRight(child);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childTop = manager.getDecoratedTop(child);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> x = childLeft + ((childRight - childLeft) / <span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line">                c.drawLine(x, childTop - mLineLength,</span><br><span class="line">                        x, childTop + mLineLength,</span><br><span class="line">                        mLinePaint);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>文章转载：<a href="http://android.jobbole.com/74208/" target="_blank" rel="external">Android中的RecyclerView: 基础知识</a></p>

          
        
      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Android/">
                #Android
              </a>
            
              <a href="/tags/UI/">
                #UI
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/23/android-basic-04/">
                Android 开发之基础知识（04）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          
            发表于 2015-03-23
          
        </span>

        
          
            <span class="post-category">
              &nbsp; | &nbsp; 分类于
              
                <a href="/categories/Android/">Android</a>

                
                

              
            </span>
          
        

        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          
            <blockquote>
<p>Android Animation + Android属性动画：动画流控制 + 进入退出 Activity 的动画示例</p>
</blockquote>
<hr>
<h3 id="Android_Animation">Android Animation</h3><blockquote>
<p>一般电影每秒播放24帧图像。</p>
<p>The Android AnimationDrawable Class</p>
<ul>
<li>The class is used to create a frame animation type of Drawable object.</li>
<li>which holds a list of drawable assets which define the frames of the animation, as well as playback parameters.</li>
</ul>
</blockquote>
<h4 id="使用_XML_创建帧动画">使用 XML 创建帧动画</h4><p>示例1</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- /res/drawable/anim_milkway.xml --&gt;</span></span><br><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">animation-list</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">android:oneshot</span>=<span class="value">"false"</span> &gt;</span> <span class="comment">&lt;!-- 动画循环播放 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span> <span class="attribute">android:drawable</span>=<span class="value">"@drawable/lunarlander0"</span> <span class="attribute">android:duration</span>=<span class="value">"250"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span> <span class="attribute">android:drawable</span>=<span class="value">"@drawable/lunarlander1"</span> <span class="attribute">android:duration</span>=<span class="value">"250"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span> <span class="attribute">android:drawable</span>=<span class="value">"@drawable/lunarlander2"</span> <span class="attribute">android:duration</span>=<span class="value">"250"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span> <span class="attribute">android:drawable</span>=<span class="value">"@drawable/lunarlander3"</span> <span class="attribute">android:duration</span>=<span class="value">"250"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span> <span class="attribute">android:drawable</span>=<span class="value">"@drawable/lunarlander4"</span> <span class="attribute">android:duration</span>=<span class="value">"250"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span> <span class="attribute">android:drawable</span>=<span class="value">"@drawable/lunarlander5"</span> <span class="attribute">android:duration</span>=<span class="value">"250"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span> <span class="attribute">android:drawable</span>=<span class="value">"@drawable/lunarlander6"</span> <span class="attribute">android:duration</span>=<span class="value">"250"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span> <span class="attribute">android:drawable</span>=<span class="value">"@drawable/lunarlander7"</span> <span class="attribute">android:duration</span>=<span class="value">"250"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">animation-list</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">ImageView</span> <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">    <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">    <span class="attribute">android:src</span>=<span class="value">"@drawable/anim_milkyway"</span></span><br><span class="line">    <span class="attribute">android:background</span>=<span class="value">"@drawable/imageviewwhitering"</span></span><br><span class="line">    <span class="attribute">android:layout_below</span>=<span class="value">"@+id/llh"</span></span><br><span class="line">    <span class="attribute">android:contentDescription</span>=<span class="value">"@string/galaxyone"</span>  /&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>android:adjustViewBounds=”true” : tells Android not to scale our referenced drawable assets, but instead to “respect” their pixel dimensions and draw them “pixel-for-pixel.”</li>
</ul>
<h4 id="使用_XML_创建_Tween_动画">使用 XML 创建 Tween 动画</h4><ul>
<li>创建 /res/anim 目录</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Rotate --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">rotate</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">android:fromDegrees</span>=<span class="value">"0.0"</span></span><br><span class="line">    <span class="attribute">android:toDegrees</span>=<span class="value">"360.0"</span></span><br><span class="line">    <span class="attribute">android:pivotX</span>=<span class="value">"50%"</span></span><br><span class="line">    <span class="attribute">android:pivotY</span>=<span class="value">"50%"</span></span><br><span class="line">    <span class="attribute">android:interpolator</span>=<span class="value">"@android:anim/linear_interpolator"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Scale --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">scale</span> <span class="attribute">android:fromXScale</span>=<span class="value">"1.0"</span></span><br><span class="line">    <span class="attribute">android:toXScale</span>=<span class="value">"0.5"</span></span><br><span class="line">    <span class="attribute">android:fromYScale</span>=<span class="value">"1.0"</span></span><br><span class="line">    <span class="attribute">android:toYScale</span>=<span class="value">"0.5"</span></span><br><span class="line">    <span class="attribute">android:pivotX</span>=<span class="value">"50%"</span></span><br><span class="line">    <span class="attribute">android:pivotY</span>=<span class="value">"50%"</span></span><br><span class="line">    <span class="attribute">android:duration</span>=<span class="value">"4500"</span></span><br><span class="line">    <span class="attribute">android:repeatCount</span>=<span class="value">"infinite"</span></span><br><span class="line">    <span class="attribute">android:repeatMode</span>=<span class="value">"reverse"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Alpha --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">alpha</span> <span class="attribute">android:fromAlpha</span>=<span class="value">"1.0"</span></span><br><span class="line">    <span class="attribute">android:toAlpha</span>=<span class="value">"0.67"</span></span><br><span class="line">    <span class="attribute">android:duration</span>=<span class="value">"2250"</span></span><br><span class="line">    <span class="attribute">android:repeatCount</span>=<span class="value">"infinite"</span></span><br><span class="line">    <span class="attribute">android:repeatMode</span>=<span class="value">"reverse"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>加载动画</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spaceShipAnim = AnimationUtils.loadAnimation(<span class="keyword">this</span>, R.anim.anim_andromeda);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">animImageView.startAnimation(spaceShipAnim);</span><br></pre></td></tr></table></figure>
<p>文章转载：《Android Apps for Absolute Beginners, 3rd》</p>
<hr>
<h3 id="Android属性动画：动画流控制">Android属性动画：动画流控制</h3><blockquote>
<p>自 KitKat 也就是 API level 19 起，我们还可以控制动画的暂停和恢复。</p>
</blockquote>
<h4 id="动画流介绍">动画流介绍</h4><p>完整的方法集合如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Animator.start()   <span class="comment">// start the animation from the beginning</span></span><br><span class="line">Animator.end()     <span class="comment">// end the animation</span></span><br><span class="line">Animator.cancel()  <span class="comment">// cancel the animation </span></span><br><span class="line">Animator.pause()   <span class="comment">// added in API 19; pause the animation</span></span><br><span class="line">Animator.resume()  <span class="comment">// added in API 19; resume a paused animation</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果动画设置了一个大于0的播放延迟（startDelay），那么调用该方法后还需要等到延迟的时间过去才回开始播放。</li>
<li>我们有两种停止动画的方法，你可以用end方法抑或cancel方法来停止一个播放着的动画。在两种方式中动画都会终止并且只有再次调用start方法才会重新开始播放。两者的区别则在于停止后动画所在的状态，<ul>
<li>当你使用cancel方法来停止动画后，动画只是停止了它的时间轴，动画的状态会停在一个中间态(intermediate state)。</li>
<li>如果通过end 方法来停止一个动画，那么动画会直接快进到该动画最后一帧并且停止，所有的对象都会保持在动画最终结束后的状态。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ObjectAnimator anim;</span><br><span class="line"> </span><br><span class="line"> <span class="annotation">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">   setContentView(R.layout.property_animations_flow);</span><br><span class="line"> </span><br><span class="line">   ImageView someImage = (ImageView) findViewById(R.id.some_image);</span><br><span class="line"> </span><br><span class="line">   anim = ObjectAnimator.ofFloat(someImage, <span class="string">"rotation"</span>, <span class="number">0</span>, <span class="number">360</span>);</span><br><span class="line">   anim.setDuration(<span class="number">1000</span>);</span><br><span class="line">   anim.setRepeatCount(<span class="number">5</span>);</span><br><span class="line">   anim.setRepeatMode(ObjectAnimator.RESTART);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startAnimation</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">   anim.start();</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endAnimation</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">   anim.end();</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelAnimation</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">   anim.cancel();</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pauseAnimation</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">   anim.pause();</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resumeAnimation</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">   anim.resume();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="动画状态的查询">动画状态的查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isStarted</span><span class="params">()</span>  <span class="comment">// added in API 14</span></span><br><span class="line"><span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">()</span></span><br><span class="line"><span class="keyword">boolean</span> <span class="title">isPaused</span><span class="params">()</span>   <span class="comment">// added in API 19</span></span></span><br></pre></td></tr></table></figure>
<p>文章转载：<a href="http://android.jobbole.com/74229/" target="_blank" rel="external">Android属性动画：动画流控制</a></p>
<hr>
<h3 id="进入退出_Activity_的动画示例">进入退出 Activity 的动画示例</h3><h4 id="示例1">示例1</h4><ul>
<li><p>res/anim/activity_open_enter.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">set</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">rotate</span></span><br><span class="line">        <span class="attribute">android:fromDegrees</span>=<span class="value">"90"</span> <span class="attribute">android:toDegrees</span>=<span class="value">"0"</span></span><br><span class="line">        <span class="attribute">android:pivotX</span>=<span class="value">"0%"</span> <span class="attribute">android:pivotY</span>=<span class="value">"0%"</span></span><br><span class="line">        <span class="attribute">android:fillEnabled</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:fillBefore</span>=<span class="value">"true"</span> <span class="attribute">android:fillAfter</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:duration</span>=<span class="value">"500"</span>  /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">alpha</span></span><br><span class="line">        <span class="attribute">android:fromAlpha</span>=<span class="value">"0.0"</span> <span class="attribute">android:toAlpha</span>=<span class="value">"1.0"</span></span><br><span class="line">        <span class="attribute">android:fillEnabled</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:fillBefore</span>=<span class="value">"true"</span> <span class="attribute">android:fillAfter</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:duration</span>=<span class="value">"500"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">set</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>res/anim/activity_open_exit.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">set</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">rotate</span></span><br><span class="line">        <span class="attribute">android:fromDegrees</span>=<span class="value">"0"</span> <span class="attribute">android:toDegrees</span>=<span class="value">"-90"</span></span><br><span class="line">        <span class="attribute">android:pivotX</span>=<span class="value">"0%"</span> <span class="attribute">android:pivotY</span>=<span class="value">"0%"</span></span><br><span class="line">        <span class="attribute">android:fillEnabled</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:fillBefore</span>=<span class="value">"true"</span> <span class="attribute">android:fillAfter</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:duration</span>=<span class="value">"500"</span>  /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">alpha</span></span><br><span class="line">        <span class="attribute">android:fromAlpha</span>=<span class="value">"1.0"</span> <span class="attribute">android:toAlpha</span>=<span class="value">"0.0"</span></span><br><span class="line">        <span class="attribute">android:fillEnabled</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:fillBefore</span>=<span class="value">"true"</span> <span class="attribute">android:fillAfter</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:duration</span>=<span class="value">"500"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">set</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>res/anim/activity_close_enter.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">set</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">rotate</span></span><br><span class="line">        <span class="attribute">android:fromDegrees</span>=<span class="value">"-90"</span> <span class="attribute">android:toDegrees</span>=<span class="value">"0"</span></span><br><span class="line">        <span class="attribute">android:pivotX</span>=<span class="value">"0%p"</span> <span class="attribute">android:pivotY</span>=<span class="value">"0%p"</span></span><br><span class="line">        <span class="attribute">android:fillEnabled</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:fillBefore</span>=<span class="value">"true"</span> <span class="attribute">android:fillAfter</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:duration</span>=<span class="value">"500"</span>  /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">alpha</span></span><br><span class="line">        <span class="attribute">android:fromAlpha</span>=<span class="value">"0.0"</span> <span class="attribute">android:toAlpha</span>=<span class="value">"1.0"</span></span><br><span class="line">        <span class="attribute">android:fillEnabled</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:fillBefore</span>=<span class="value">"true"</span> <span class="attribute">android:fillAfter</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:duration</span>=<span class="value">"500"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">set</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>res/anim/activity_close_exit.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">set</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">rotate</span></span><br><span class="line">        <span class="attribute">android:fromDegrees</span>=<span class="value">"0"</span> <span class="attribute">android:toDegrees</span>=<span class="value">"90"</span></span><br><span class="line">        <span class="attribute">android:pivotX</span>=<span class="value">"0%p"</span> <span class="attribute">android:pivotY</span>=<span class="value">"0%p"</span></span><br><span class="line">        <span class="attribute">android:fillEnabled</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:fillBefore</span>=<span class="value">"true"</span> <span class="attribute">android:fillAfter</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:duration</span>=<span class="value">"500"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">alpha</span></span><br><span class="line">        <span class="attribute">android:fromAlpha</span>=<span class="value">"1.0"</span> <span class="attribute">android:toAlpha</span>=<span class="value">"0.0"</span></span><br><span class="line">        <span class="attribute">android:fillEnabled</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:fillBefore</span>=<span class="value">"true"</span> <span class="attribute">android:fillAfter</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:duration</span>=<span class="value">"500"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">set</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>code</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(...);</span><br><span class="line">startActivity(intent);</span><br><span class="line">overridePendingTransition(R.anim.activity_open_enter, R.anim.activity_open_exit);</span><br><span class="line"><span class="comment">//Close the current Activity with custom transition</span></span><br><span class="line">finish();</span><br><span class="line">overridePendingTransition(R.anim.activity_close_enter, R.anim.activity_close_exit);</span><br></pre></td></tr></table></figure>
</li>
<li><p>globally setting</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">style</span> <span class="attribute">name</span>=<span class="value">"AppTheme"</span> <span class="attribute">parent</span>=<span class="value">"android:Theme.Holo.Light"</span>&gt;</span><span class="css"></span><br><span class="line">        &lt;<span class="tag">item</span> <span class="tag">name</span>="<span class="tag">android</span><span class="pseudo">:windowAnimationStyle"</span>&gt;<span class="at_rule">@<span class="keyword">style/ActivityAnimation&lt;/item&gt;</span></span><br><span class="line">    </span></span><span class="tag">&lt;/<span class="title">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">style</span> <span class="attribute">name</span>=<span class="value">"ActivityAnimation"</span> <span class="attribute">parent</span>=<span class="value">"@android:style/Animation.Activity"</span>&gt;</span><span class="css"></span><br><span class="line">        &lt;<span class="tag">item</span> <span class="tag">name</span>="<span class="tag">android</span><span class="pseudo">:activityOpenEnterAnimation"</span>&gt;<span class="at_rule">@<span class="keyword">anim/activity_open_enter&lt;/item&gt;</span></span><br><span class="line">        &lt;item name=<span class="string">"android:activityOpenExitAnimation"</span>&gt;@anim/activity_open_exit&lt;/item&gt;</span><br><span class="line">        &lt;item name=<span class="string">"android:activityCloseEnterAnimation"</span>&gt;@anim/activity_close_enter&lt;/item&gt;</span><br><span class="line">        &lt;item name=<span class="string">"android:activityCloseExitAnimation"</span>&gt;@anim/activity_close_exit&lt;/item&gt;</span><br><span class="line">    </span></span><span class="tag">&lt;/<span class="title">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>同理， res/animator/fragment_exit.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">set</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">objectAnimator</span></span><br><span class="line">        <span class="attribute">android:valueFrom</span>=<span class="value">"0"</span> <span class="attribute">android:valueTo</span>=<span class="value">"-90"</span></span><br><span class="line">        <span class="attribute">android:valueType</span>=<span class="value">"floatType"</span></span><br><span class="line">        <span class="attribute">android:propertyName</span>=<span class="value">"rotation"</span></span><br><span class="line">        <span class="attribute">android:duration</span>=<span class="value">"500"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">objectAnimator</span></span><br><span class="line">        <span class="attribute">android:valueFrom</span>=<span class="value">"1.0"</span> <span class="attribute">android:valueTo</span>=<span class="value">"0.0"</span></span><br><span class="line">        <span class="attribute">android:valueType</span>=<span class="value">"floatType"</span></span><br><span class="line">        <span class="attribute">android:propertyName</span>=<span class="value">"alpha"</span></span><br><span class="line">        <span class="attribute">android:duration</span>=<span class="value">"500"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">set</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>code</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FragmentTransaction ft = getFragmentManager().beginTransaction();</span><br><span class="line">    <span class="comment">//Must be called first!</span></span><br><span class="line">    ft.setCustomAnimations(R.animator.fragment_enter,</span><br><span class="line">            R.animator.fragment_exit,</span><br><span class="line">            R.animator.fragment_pop_enter,</span><br><span class="line">            R.animator.fragment_pop_exit);</span><br><span class="line">    ft.replace(R.id.container_fragment, fragment);</span><br><span class="line">    ft.addToBackStack(<span class="keyword">null</span>);</span><br><span class="line">ft.commit();</span><br></pre></td></tr></table></figure>
</li>
<li><p>res/values/styles.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">style</span> <span class="attribute">name</span>=<span class="value">"AppTheme"</span> <span class="attribute">parent</span>=<span class="value">"android:Theme.Holo.Light"</span>&gt;</span><span class="css"></span><br><span class="line">        &lt;<span class="tag">item</span> <span class="tag">name</span>="<span class="tag">android</span><span class="pseudo">:windowAnimationStyle"</span>&gt;</span><br><span class="line">            <span class="at_rule">@<span class="keyword">style/FragmentAnimation&lt;/item&gt;</span></span><br><span class="line">    </span></span><span class="tag">&lt;/<span class="title">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">style</span> <span class="attribute">name</span>=<span class="value">"FragmentAnimation"</span></span><br><span class="line">        <span class="attribute">parent</span>=<span class="value">"@android:style/Animation.Activity"</span>&gt;</span><span class="css"></span><br><span class="line">        &lt;<span class="tag">item</span> <span class="tag">name</span>="<span class="tag">android</span><span class="pseudo">:fragmentOpenEnterAnimation"</span>&gt;</span><br><span class="line">            <span class="at_rule">@<span class="keyword">animator/fragment_enter&lt;/item&gt;</span></span><br><span class="line">        &lt;item name=<span class="string">"android:fragmentOpenExitAnimation"</span>&gt;</span><br><span class="line">            @animator/fragment_exit&lt;/item&gt;</span><br><span class="line">        &lt;item name=<span class="string">"android:fragmentCloseEnterAnimation"</span>&gt;</span><br><span class="line">            @animator/fragment_pop_enter&lt;/item&gt;</span><br><span class="line">        &lt;item name=<span class="string">"android:fragmentCloseExitAnimation"</span>&gt;</span><br><span class="line">            @animator/fragment_pop_exit&lt;/item&gt;</span><br><span class="line">        &lt;item name=<span class="string">"android:fragmentFadeEnterAnimation"</span>&gt;</span><br><span class="line">            @android:animator/fade_in&lt;/item&gt;</span><br><span class="line">        &lt;item name=<span class="string">"android:fragmentFadeExitAnimation"</span>&gt;</span><br><span class="line">            @android:animator/fade_out&lt;/item&gt;</span><br><span class="line">    </span></span><span class="tag">&lt;/<span class="title">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="示例2">示例2</h4><p><strong>Animating Layout Changes</strong></p>
<ul>
<li>APPEARING: An item that is appearing in the container</li>
<li>DISAPPEARING: An item that is disappearing from the container</li>
<li>CHANGING: An item that is changing because of a layout change, such as a resize, that doesn’t involve views being added or removed</li>
<li>CHANGE_APPEARING: An item changing because of another view appearing</li>
<li>CHANGE_DISAPPEARING: An item changing because of another view disappearing</li>
</ul>
<p><strong>code</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    LinearLayout mContainer;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.main);</span><br><span class="line">        <span class="comment">// Layout Changes Animation</span></span><br><span class="line">        mContainer = (LinearLayout) findViewById(R.id.verticalContainer);</span><br><span class="line">        LayoutTransition transition = <span class="keyword">new</span> LayoutTransition();</span><br><span class="line">        mContainer.setLayoutTransition(transition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Override the default appear animation with a flip in</span></span><br><span class="line">        Animator appearAnim = ObjectAnimator.ofFloat(<span class="keyword">null</span>,</span><br><span class="line">            <span class="string">"rotationY"</span>, <span class="number">90f</span>, <span class="number">0f</span>).setDuration(transition.getDuration(LayoutTransition.APPEARING));</span><br><span class="line">        transition.setAnimator(LayoutTransition.APPEARING, appearAnim);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Override the default disappear animation with a flip out</span></span><br><span class="line">        Animator disappearAnim = ObjectAnimator.ofFloat(<span class="keyword">null</span>,</span><br><span class="line">            <span class="string">"rotationX"</span>, <span class="number">0f</span>, <span class="number">90f</span>).setDuration(transition.getDuration(LayoutTransition.DISAPPEARING));</span><br><span class="line">        transition.setAnimator(LayoutTransition.DISAPPEARING, disappearAnim);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Override the default change with a more animated slide</span></span><br><span class="line">        <span class="comment">// We animate several properties at once, so we create an</span></span><br><span class="line">        <span class="comment">// animation out of multiple PropertyValueHolder objects.</span></span><br><span class="line">        <span class="comment">// This animation slides the views in and temporarily shrinks</span></span><br><span class="line">        <span class="comment">// the view to half size.</span></span><br><span class="line">        PropertyValuesHolder pvhSlide = PropertyValuesHolder.ofFloat(<span class="string">"y"</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">        PropertyValuesHolder pvhScaleY = PropertyValuesHolder.ofFloat(<span class="string">"scaleY"</span>, <span class="number">1f</span>, <span class="number">0.5f</span>, <span class="number">1f</span>);</span><br><span class="line">        PropertyValuesHolder pvhScaleX = PropertyValuesHolder.ofFloat(<span class="string">"scaleX"</span>, <span class="number">1f</span>, <span class="number">0.5f</span>, <span class="number">1f</span>);</span><br><span class="line">        Animator changingAppearingAnim =</span><br><span class="line">            ObjectAnimator.ofPropertyValuesHolder(<span class="keyword">this</span>, pvhSlide, pvhScaleY, pvhScaleX);</span><br><span class="line">        changingAppearingAnim.setDuration(</span><br><span class="line">            transition.getDuration(LayoutTransition.CHANGE_DISAPPEARING)</span><br><span class="line">        );</span><br><span class="line">        transition.setAnimator(LayoutTransition.CHANGE_DISAPPEARING, changingAppearingAnim);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAddClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        Button button = <span class="keyword">new</span> Button(<span class="keyword">this</span>);</span><br><span class="line">        button.setText(<span class="string">"Click To Remove"</span>);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                mContainer.removeView(v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        mContainer.addView(button, <span class="keyword">new</span> LinearLayout.LayoutParams(</span><br><span class="line">                LayoutParams.MATCH_PARENT, LayoutParams.WRAP_CONTENT));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Android/">
                #Android
              </a>
            
              <a href="/tags/Animation/">
                #Animation
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/23/android-basic-03/">
                Android 开发之基础知识（03）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          
            发表于 2015-03-23
          
        </span>

        
          
            <span class="post-category">
              &nbsp; | &nbsp; 分类于
              
                <a href="/categories/Android/">Android</a>

                
                

              
            </span>
          
        

        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          
            <blockquote>
<p>使用 Service</p>
</blockquote>
<hr>
<h3 id="使用_Service">使用 Service</h3><h4 id="定义_Intent">定义 Intent</h4><ul>
<li>optionally populate the Intent with other information that further  describes  how  to  handle  the  request.</li>
<li>as a messaging construct that you can dispatch to request some sort of “action” from one of the other components.</li>
</ul>
<table>
<thead>
<tr>
<th>Intent attribute</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Action</td>
<td>eg. android.intent.action.DIAL</td>
</tr>
<tr>
<td>Category</td>
<td>Describes where and how the Intent can be used, such as from the main Android menu or from the browser</td>
</tr>
<tr>
<td>Component</td>
<td>Specifies an explicit package and class to use for the Intent, instead of inferring from action, type, and categories</td>
</tr>
<tr>
<td>Data</td>
<td>Data to work with, expressed as a URI (for example, content://contacts/1)</td>
</tr>
<tr>
<td>Extras</td>
<td>Extra data to pass to the Intent in the form of a Bundle</td>
</tr>
<tr>
<td>Type</td>
<td>Specifies an explicit MIME type, such as text/plain or vnd.android.cursor.item/email_v2</td>
</tr>
</tbody>
</table>
<ul>
<li>Data<br><img src="http://7xi7e6.com1.z0.glb.clouddn.com/intent-attr-data-construct.png" alt="data-construct"></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW</span><br><span class="line">    Uri.parse(”weather:<span class="comment">//com.msi.manning /loc?zip=12345”);</span></span><br></pre></td></tr></table></figure>
<h4 id="理解_Service_生命周期">理解 Service 生命周期</h4><ul>
<li>2 个生命周期回调：onCreate() 和 onDestroy()</li>
<li>执行于 UI Thread</li>
</ul>
<h4 id="启动_Service_(两种启动方式)">启动 Service (两种启动方式)</h4><ul>
<li>接收 Intent 后，通过 Context.startService() 启动<ul>
<li>之后触发 onStartCommand()， 该方法返回值有4种：<ul>
<li>START_STICKY， 告知系统在出于内存不足等原因停止后其想要重启，重启后 Intent 值为 null，需要手动保存内部状态；</li>
<li>START_NOT_STICKY， 告知系统其不想要重启；</li>
<li>START_REDELIVER_INTENT， 类似 START_STICKY， 但原先未执行完的 Intent 将被重新使用；</li>
</ul>
</li>
</ul>
</li>
<li>时序图 - 关于 Activity 与 Service 的交互</li>
</ul>
<p><img src="http://7xi7e6.com1.z0.glb.clouddn.com/sequence-uml-activity-service-interaction.png" alt="sequence-uml-activity-service-interaction"></p>
<ul>
<li>通过客户端以绑定方式  Context.bindService() 启动</li>
</ul>
<p><img src="http://7xi7e6.com1.z0.glb.clouddn.com/sequence-uml-service-local-binding.png" alt="sequence-uml-service-local-binding"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLocalService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> LocalBinder mLocalBinder = <span class="keyword">new</span> LocalBinder();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mLocalBinder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doLongRunningOperation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Start new thread for long running operation...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> MyLocalService <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> MyLocalService.<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">ServiceConnection</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MyLocalService mService;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.main);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">        Intent bindIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MyLocalService.class);</span><br><span class="line">        bindService(bindIntent, <span class="keyword">this</span>, BIND_AUTO_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">        <span class="keyword">if</span> (mService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            unbindService(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</span><br><span class="line">        mService = ((MyLocalService.LocalBinder) iBinder).getService();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</span><br><span class="line">        mService = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="保持活动_（Staying_Alive）">保持活动 （Staying Alive）</h4><ul>
<li>Service.startForeground()</li>
<li>Service.stopForeground()<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123; </span><br><span class="line">        String action = intent.getAction();</span><br><span class="line">        <span class="keyword">if</span> (ACTION_SHARE_PHOTO.equals(action)) &#123;</span><br><span class="line">            <span class="comment">// Build the notification to be shown</span></span><br><span class="line">            Notification.Builder builder = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>);</span><br><span class="line">            builder.setSmallIcon(R.drawable.notification_icon);</span><br><span class="line">            builder.setContentTitle(getString(R.string.notification_title));</span><br><span class="line">            builder.setContentText(getString(R.string.notification_text));</span><br><span class="line">            Notification notification = builder.build();</span><br><span class="line">            <span class="comment">// Start the service in the foreground</span></span><br><span class="line">            startForeground(NOTIFICATION_ID, notification);</span><br><span class="line">            <span class="comment">// Perform out background operation…</span></span><br><span class="line">            String photoText = intent.getStringExtra(EXTRA_PHOTO_TEXT);</span><br><span class="line">            Bitmap photoBitmap =</span><br><span class="line">                   intent.getParcelableExtra(EXTRA_PHOTO_BITMAP);</span><br><span class="line">            uploadPhotoWithText(photoBitmap, photoText);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> START_NOT_STICKY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="停止_Service">停止 Service</h4><ul>
<li>Service.stopSelf() or Context.stopService()</li>
<li>the last client disconnects (that is, called Context.unbindService()).</li>
</ul>
<h4 id="一个示例">一个示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMusicPlayer</span> <span class="keyword">extends</span> <span class="title">Service</span></span><br><span class="line">             <span class="keyword">implements</span> <span class="title">MediaPlayer</span>.<span class="title">OnCompletionListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_ADD_TO_QUEUE =</span><br><span class="line">                               “com.aptl.services.ADD_TO_QUEUE”;</span><br><span class="line">    <span class="keyword">private</span> ConcurrentLinkedQueue&lt;Uri&gt; mTrackQueue;</span><br><span class="line">    <span class="keyword">private</span> MediaPlayer mMediaPlayer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        mTrackQueue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;Uri&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        String action = intent.getAction();</span><br><span class="line">        <span class="keyword">if</span> (ACTION_ADD_TO_QUEUE.equals(action)) &#123;</span><br><span class="line">            Uri trackUri = intent.getData();</span><br><span class="line">            addTrackToQueue(trackUri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> START_NOT_STICKY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        <span class="keyword">if</span>(mMediaPlayer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mMediaPlayer.release();</span><br><span class="line">            mMediaPlayer = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="javadoc">/**</span><br><span class="line">     * Add track to end of queue if already playing,</span><br><span class="line">     * otherwise create a new MediaPlayer and start playing.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addTrackToQueue</span><span class="params">(Uri trackUri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mMediaPlayer == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mMediaPlayer = MediaPlayer.create(<span class="keyword">this</span>, trackUri);</span><br><span class="line">                mMediaPlayer.setOnCompletionListener(<span class="keyword">this</span>);</span><br><span class="line">                mMediaPlayer.prepare();</span><br><span class="line">                mMediaPlayer.start();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                stopSelf();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mTrackQueue.offer(trackUri);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Track completed, start playing next or stop service...</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(MediaPlayer mediaPlayer)</span> </span>&#123;</span><br><span class="line">        mediaPlayer.reset();</span><br><span class="line">        Uri nextTrackUri = mTrackQueue.poll();</span><br><span class="line">        <span class="keyword">if</span>(nextTrackUri != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mMediaPlayer.setDataSource(<span class="keyword">this</span>, nextTrackUri);</span><br><span class="line">                mMediaPlayer.prepare();</span><br><span class="line">                mMediaPlayer.start();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                stopSelf();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            stopSelf();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="IntentService">IntentService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyIntentService</span> <span class="keyword">extends</span> <span class="title">IntentService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = “MyIntentService”;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_UPLOAD_PHOTO = “com.aptl.services.UPLOAD_PHOTO”;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_PHOTO = “bitmapPhoto”;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_SEND_MESSAGE = “com.aptl.services.SEND_MESSAGE”;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_MESSAGE = “messageText”;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_RECIPIENT = “messageRecipient”;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyIntentService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(NAME);</span><br><span class="line">        <span class="comment">// We don’t want intents redelivered in case we’re shut down unexpectedly</span></span><br><span class="line">        setIntentRedelivery(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="javadoc">/**</span><br><span class="line">     * This method is executed on its own thread, one intent at a time...</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        String action = intent.getAction();</span><br><span class="line">        <span class="keyword">if</span>(ACTION_SEND_MESSAGE.equals(action)) &#123;</span><br><span class="line">            String messageText = intent.getStringExtra(EXTRA_MESSAGE);</span><br><span class="line">            String messageRecipient = intent.getStringExtra(EXTRA_RECIPIENT);</span><br><span class="line">            sendMessage(messageRecipient, messageText);</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span><span class="params">(ACTION_UPLOAD_PHOTO.equals(action)</span>) </span>&#123;</span><br><span class="line">            Bitmap photo = intent.getParcelableExtra(EXTRA_PHOTO);</span><br><span class="line">            uploadPhoto(photo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(String messageRecipient, String messageText)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Make network call...</span></span><br><span class="line">        <span class="comment">// TODO Send a broadcast that operation is completed</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">uploadPhoto</span><span class="params">(Bitmap photo)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Make network call...</span></span><br><span class="line">        <span class="comment">// TODO Send a broadcast that operation is completed</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文章转载：《Android Programming Pushing》 + 《Android in Action》 + 《Android Apps for Absolute Beginners, 3rd》</p>

          
        
      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Android/">
                #Android
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/23/android-advanced-custom-view/">
                Android 进阶之自定义视图（View）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          
            发表于 2015-03-23
          
        </span>

        
          
            <span class="post-category">
              &nbsp; | &nbsp; 分类于
              
                <a href="/categories/Android/">Android</a>

                
                

              
            </span>
          
        

        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          
            <h3 id="基础知识">基础知识</h3><h4 id="View_的类层次">View 的类层次</h4><ul>
<li>View</li>
<li>ViewParent (interface)<ul>
<li>defines the protocol for any object that wants to play the role of a parent to other views. </li>
</ul>
</li>
<li>ViewGroup (extends View and implements ViewParent)<ul>
<li>defines the protocol for a collection of child views.</li>
<li>plays a central role in placing the controls (views) at the right place.</li>
<li>also controls the background and animation of its child views.</li>
</ul>
</li>
<li>ViewRoot (aslo called ViewRootImplementation, implements ViewParent)<ul>
<li>this class is important for understanding how drawing is done in Android.</li>
</ul>
</li>
</ul>
<h4 id="View_的生命周期">View 的生命周期</h4><p><img src="http://7xi7e6.com1.z0.glb.clouddn.com/view_lifecycle.png" alt="View lifecycle"></p>
<p><strong>Layout Phase : Measurement and Layout</strong></p>
<ul>
<li>目的 -&gt; 获取 View 的大小和位置。</li>
<li>该阶段包含两个过程：measure + layout<ul>
<li>public final void measure(int widthMeasureSpec, int heightMeasureSpec)<ul>
<li>The derived views need to set their dimensions by calling setMeasuredDimension().</li>
<li>If the inherited custom view is a collection of other views, as in a ViewGroup, then you need to call measure() on child views in your onMeasure() method.</li>
</ul>
</li>
<li>public void layout(int left, int top, int right, int bottom)<ul>
<li>protected void onSizeChanged(int w, int h, int oldw, int oldh)</li>
<li>protected void onLayout(boolean changed, int left, int top, int right, int bottom)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>Drawing Phase : Mechanics of onDraw</strong></p>
<blockquote>
<p>The protocol implemented by this method is:</p>
<ul>
<li>Draw the background</li>
<li>Draw view’s content by delegating to onDraw()</li>
<li>Draw children by delegating to dispatchDraw()</li>
<li>Draw decorations such as scroll bars</li>
</ul>
</blockquote>
<h4 id="实践_Measure_过程">实践 Measure 过程</h4><ul>
<li><p>Android passes something called a mode bit to onMeasure( ) to give context to calculating the size of the view. This mode bit can be one of three: <strong>AT_MOST</strong>, <strong>UNSPECIFIED</strong>, and <strong>EXACT</strong>.</p>
</li>
<li><p>Default Implementation of onMeasure() by the View Class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = size;</span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        result = size;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        result = specSize;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>另一种方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    setMeasuredDimension(getImprovedDefaultWidth(widthMeasureSpec),</span><br><span class="line">            getImprovedDefaultHeight(heightMeasureSpec));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getImprovedDefaultHeight</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">    <span class="keyword">int</span> specSize =  MeasureSpec.getSize(measureSpec);</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        <span class="keyword">return</span> hGetMaximumHeight();</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        <span class="keyword">return</span> specSize;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">        <span class="keyword">return</span> hGetMinimumHeight();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//you shouldn't come here</span></span><br><span class="line">    Log.e(tag,<span class="string">"unknown specmode"</span>);</span><br><span class="line">    <span class="keyword">return</span> specSize;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">hGetMinimumHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getSuggestedMinimumHeight();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">hGetMinimumWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getSuggestedMinimumWidth();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="onDraw()">onDraw()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line">    <span class="keyword">int</span> w = <span class="keyword">this</span>.getWidth();</span><br><span class="line">    <span class="keyword">int</span> h = <span class="keyword">this</span>.getHeight();</span><br><span class="line">    <span class="keyword">int</span> t = <span class="keyword">this</span>.getTop();</span><br><span class="line">    <span class="keyword">int</span> l = <span class="keyword">this</span>.getLeft();</span><br><span class="line">    <span class="keyword">int</span> ox = w/<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> oy = h/<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> rad = Math.min(ox,oy)/<span class="number">2</span>;</span><br><span class="line">    canvas.drawCircle(ox, oy, rad, getBrush());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Paint <span class="title">getBrush</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Paint p = <span class="keyword">new</span> Paint();</span><br><span class="line">    p.setAntiAlias(<span class="keyword">true</span>);</span><br><span class="line">    p.setStrokeWidth(strokeWidth);</span><br><span class="line">    p.setColor(strokeColor);</span><br><span class="line">    p.setStyle(Paint.Style.STROKE);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="响应事件">响应事件</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircleView</span></span><br><span class="line"><span class="keyword">extends</span> <span class="keyword">implements</span> <span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">....<span class="function">other stuff</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initCircleView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...other stuff</span><br><span class="line">        <span class="keyword">this</span>.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.setClickable(<span class="keyword">true</span>);</span><br><span class="line">        ...other stuff</span><br><span class="line">    &#125;</span><br><span class="line">    ....<span class="function">other stuff</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//increase the radius</span></span><br><span class="line">        defRadius *= <span class="number">1.2</span>;</span><br><span class="line">        adjustMinimumHeight();</span><br><span class="line">        requestLayout();</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">adjustMinimumHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setMinimumHeight(defRadius * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span>.setMinimumWidth(defRadius * <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ....other stuff</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="自定义属性">自定义属性</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"</span><br><span class="line">    xmlns:circleViewPkg="http://schemas.android.com/apk/res/com.androidbook.custom"</span><br><span class="line">    .... </span><br><span class="line">&lt;com.androidbook.custom.CircleView</span><br><span class="line">    android:id="@+id/circle_view_id"</span><br><span class="line">    android:layout_width="wrap_content"</span><br><span class="line">    android:layout_height="wrap_content"</span><br><span class="line">    circleViewPkg:strokeWidth="5"</span><br><span class="line">    circleViewPkg:strokeColor="@android:color/holo_red_dark"</span><br><span class="line">    /&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br><span class="line">...</span><br><span class="line">&lt;resources&gt;</span><br><span class="line">&lt;declare-styleable name="CircleView"&gt;</span><br><span class="line">    &lt;attr name="strokeWidth" format="integer"/&gt;</span><br><span class="line">    &lt;attr name="strokeColor" format="color|reference" /&gt;</span><br><span class="line">&lt;/declare-styleable&gt;</span><br><span class="line">&lt;/resources&gt;</span><br><span class="line">...</span><br><span class="line">&lt;!--</span><br><span class="line">  R.attr.strokeWidth (int)</span><br><span class="line">  R.attr.srokeColor (int)</span><br><span class="line">  R.styleable.CircelView (an array of ints)</span><br><span class="line">  R.styleable.CircleView_strokeWidth (offset into the array)</span><br><span class="line">  R.styleable.CircelView_strokeColor (offset into the array)</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CircleView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context, attrs, defStyle);</span><br><span class="line">    <span class="comment">//Use the array constant to read the bag once</span></span><br><span class="line">    TypedArray t = context.obtainStyledAttributes(attrs,</span><br><span class="line">                     R.styleable.CircleView,</span><br><span class="line">                     defStyle,   <span class="comment">//if any values are in the theme, do you have your own style group</span></span><br><span class="line">                     <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    strokeColor = t.getColor(R.styleable.CircleView_strokeColor, strokeColor);</span><br><span class="line">    strokeWidth = t.getInt(R.styleable.CircleView_strokeWidth, strokeWidth);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Recycle the typed array</span></span><br><span class="line">    t.recycle();</span><br><span class="line"></span><br><span class="line">    initCircleView();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文章转载：《Expert Android》 + 《Android Programming Pushing》</p>

          
        
      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Android/">
                #Android
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/22/android-memory-clean/">
                Android 系统的内存回收机制
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          
            发表于 2015-03-22
          
        </span>

        
          
            <span class="post-category">
              &nbsp; | &nbsp; 分类于
              
                <a href="/categories/Android/">Android</a>

                
                

              
            </span>
          
        

        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          
            <h3 id="Android_内存回收原则">Android 内存回收原则</h3><p>回收优先级：</p>
<ul>
<li>IMPORTANCE_FOREGROUND:</li>
<li>IMPORTANCE_VISIBLE:</li>
<li>IMPORTANCE_SERVICE:</li>
<li>IMPORTANCE_BACKGROUND:</li>
<li>IMPORTANCE_EMPTY:</li>
</ul>
<ul>
<li>ActivityManagerService 集中管理所有进程的内存资源分配。</li>
<li>所有进程需要申请或释放内存之前必须调用 ActivityManagerService 对象，获得其“许可”之后才能进行下一步操作，或者 ActivityManagerService 将直接“代劳”。</li>
<li>类 ActivityManagerService 中涉及到内存回收的几个重要的成员方法如下：trimApplications()，updateOomAdjLocked()，activityIdleInternal()。</li>
</ul>
<p>系统中的内存回收可分为两个层次，即默认内存回收与内核级内存回收。</p>
<h3 id="回收动作入口：activityIdleInternal()">回收动作入口：activityIdleInternal()</h3><p>Android 系统中内存回收的触发点大致可分为三种情况。</p>
<ol>
<li>用户程序调用 StartActivity(), 使当前活动的 Activity 被覆盖；</li>
<li>用户按 back 键，退出当前应用程序；</li>
<li>启动一个新的应用程序。</li>
</ol>
<p>这些能够触发内存回收的事件最终调用的函数接口就是 activityIdleInternal()。当 ActivityManagerService 接收到异步消息 IDLE_TIMEOUT_MSG 或者 IDLE_NOW_MSG 时，activityIdleInternal() 将会被调用。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IDLE_NOW_MSG 的处理方式</span></span><br><span class="line"><span class="keyword">case</span> IDLE_NOW_MSG:&#123;</span><br><span class="line"> IBinder token = (Ibinder)msg.obj;</span><br><span class="line">    activityIdle(token, <span class="keyword">null</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// IDLE_TIMEOUT_MSG 的处理方式</span></span><br><span class="line"><span class="keyword">case</span> IDLE_TIMEOUT_MSG: &#123;</span><br><span class="line"> <span class="keyword">if</span> (mDidDexOpt) &#123;</span><br><span class="line">        mDidDexOpt = <span class="keyword">false</span>;</span><br><span class="line">        Message nmsg = mHandler.obtainMessage(IDLE_TIMEOUT_MSG);</span><br><span class="line">        nmsg.obj = msg.obj;</span><br><span class="line">        mHandler.sendMessageDelayed(nmsg, IDLE_TIMEOUT);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IBinder token = (IBinder)msg.obj;</span><br><span class="line">    Slog.w(TAG, <span class="string">"Activity idle timeout for "</span> + token);</span><br><span class="line">    activityIdleInternal(token, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>activityIdleInternal() 的主要任务是改变系统中 Activity 的状态信息，并将其添加到不同状态列表中。其主要工作如下：</p>
<ul>
<li>首先，调用 scheduleAppGcsLocked() 方法通知所有进行中的任务进行垃圾回收。scheduleAppGcsLocked() 将进行调度 JVM 的 garbage collect，回收一部分内存空间，这里仅仅是通知每个进程自行进程垃圾检查并调度回收时间，而非同步回收。</li>
<li>然后，取出 mStoppingActivities 和 mFinishigActivities 列表中的所有内容，暂存在临时变量中。这两个列表分别存储了当前状态为 stop 和 finishi 的 activity 对象。对于 stop 列表，<ul>
<li>如果其中的 activity 的 finish 状态为 true，判断是不是要立即停止，如果要立即停止则调用 destroyActivityLocked() 通知目标进程调用 onDestroy() 方法，否则，先调用 resumeTopActivity() 运行下一个 Activity。</li>
<li>如果 finish 状态为 false，则调用 stopActivityLocked() 通知客户进程停止该 Activity，这种情况一般发生在调用 startActivity() 后。对于 finish 列表，直接调用 destroyActivityLocked() 通知客户进程销毁目标 Activity。</li>
</ul>
</li>
</ul>
<p>这里的 destroyActivityLocked 等函数并没有真正意义上改变内存的使用，只是将其状态改变为“允许回收”，真正的回收在下面即将调用的 trimApplications() 函数中。</p>
<h4 id="回收过程函数_trimApplications()">回收过程函数 trimApplications()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">trimApplications</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// First remove any unused application processes whose package</span></span><br><span class="line">        <span class="comment">// has been removed.</span></span><br><span class="line">        <span class="keyword">for</span> (i=mRemovedProcesses.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">           (<span class="number">1</span>)<span class="comment">//kill process;</span></span><br><span class="line">        &#125;</span><br><span class="line">          <span class="keyword">if</span> (!updateOomAdjLocked()) &#123;</span><br><span class="line">           (<span class="number">2</span>)<span class="comment">//do something default</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Finally, if there are too many activities now running, try to</span></span><br><span class="line">        <span class="comment">// finish as many as we can to get back down to the limit.</span></span><br><span class="line">           (<span class="number">3</span>)do something</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>当程序执行到 trimApplications() 之后，首先检查 mRemovedProcesses 列表中的进程。mRemovedProcesses 列表中主要包含了 crash 的进程、5 秒内没有响应并被用户选在强制关闭的进程、以及应用开发这调用 killBackgroundProcess 想要杀死的进程。调用 Process.killProcess 将所有此类进程全部杀死。</li>
<li>调用 updateOomAdjLocked() 函数，若成功返回，说明 Linux 内核支持 setOomAdj() 接口，updateOomAdjLocked 将修改 adj 的值并通知 linux 内核，内核根据 adj 值以及内存使用情况动态管理进程资源（lowmemorykiller 和 oom_killer）。若 updateOomAdjLocked() 返回为假，则表示当前系统不支持 setOomAdj() 接口，将在本地进行默认的资源回收。</li>
<li>最后，如果当前依然运行了过多的 Activity，对多余的 Activity 进行回收。 trimApplications() 的大多数的代码都在处理 Oom_killer 不存在情况下的默认资源回收，<br>下面对其默认回收过程（即代码清单中标记（2）的位置）进行进一步分析。其回收过程可大致描述如下。<ul>
<li>步骤一，获取当前所有运行的进程 mLruProcesses，mLruProcesses 中的排序规则是按最近使用时间。对 mLruProcesses 中不能被关闭的进程进行计数，这些不能被关闭的进程包括运行 service 的进程，运行 broadcast receiver 的进程等，见如下代码。</li>
<li>步骤二， 设当前最大运行进程数 curMaxProcs = curMaxProcs + numServiceProcs（即默认最大进程数与运行 Service 的进程数之和），如果当前进程的数量 mRemovedProcesses.size() 大于这个值，则遍历所有当前运行的进程，杀死符合条件的那些进程并释放内存。清理过程见清单 5（部分代码省略）。从清单 5 的代码中可以看出，进程被杀死的条件（缺一不可）是：<ul>
<li>必须是非 persistent 进程，即非系统进程；</li>
<li>必须是空进程，即进程中没有任何 activity 存在。如果杀死存在 Activity 的进程，有可能关闭用户正在使用的程序，或者使应用程序恢复的时延变大，从而影响用户体验；</li>
<li>必须无 broadcast receiver。运行 broadcast receiver 一般都在等待一个事件的发生，用户并不希望此类程序被系统强制关闭；</li>
<li>进程中 service 的数量必须为 0。存在 service 的进程很有可能在为一个或者多个程序提供某种服务，如 GPS 定位服务。杀死此类进程将使其他进程无法正常服务。</li>
</ul>
</li>
<li>步骤三，再次检查当前运行的进程，如果 mRemovedProcesses.size() 仍然大于 curMaxProcs，则放宽条件再次进行回收。判断条件见代码清单 6（部分代码省略）。下面代码中，布尔变量 canQuit 的值为真时，那么这个进程可以被回收。canQuit 的取值分两个步骤，首先是根据进程的属性赋值。 1. 必须是非 persistent 进程，即非系统进程；2. 必须无 broadcast receiver；3. 进程中 service 的数量必须为 0；4. persistent 类型的 activity 数量为 0。与步骤二唯一的不同在第 4 条，这里不要求进程是空进程，只要进程中没有 persistent 类型的 Activity 就可以（Activity 是否是 persistent 类型在开发阶段指定）。这些条件都满足时，再检查进程中每个 Activity 的属性，当该进程中所有的 Activity 都还必须满足三个条件：Activity 的状态已经保存，当前处在不可见状态并且 Activity 已经 Stop。这时杀掉进程只会降低下次调用程序时的加载速度，下次启动时将恢复到关闭之前的状态，并不会在用户体验上造成致命的影响，所以，canQuit 置位为真。这种情况与步骤二的回收方式也有所不同，由于进程中 Activity 的数量不是 0，下一步需要对每个 activity 执行 destroyActivityLocked() 销毁，最后才杀死进程。</li>
<li><ul>
<li>步骤四，上面 3 个过程都是针对整个 process 进行的资源回收。在以上过程执行完毕之后，将在更小的粒度上对 Activity 的资源进行回收。与上面所述类似，列表 mLRUActivities 存储了当前所有运行中的 Activity，排序规则同样为最少访问原则。mLRUActivities.size() 返回系统中运行的 Activity 的数量，当其大于 MAX_ACTIVITIES（MAX_ACTIVITIES 是一个常量，一般值为 20，代表系统中最大允许同时存在的 Activity）时。将回收部分满足条件的 Activity 以减少内存的使用。</li>
</ul>
</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行 destroyActivityLocked() 销毁</span></span><br><span class="line"><span class="keyword">boolean</span> canQuit = !app.persistent &amp;&amp; app.curReceiver == <span class="keyword">null</span></span><br><span class="line"> &amp;&amp; app.services.size() == <span class="number">0</span></span><br><span class="line">    &amp;&amp; app.persistentActivities == <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">int</span> NUMA = app.activities.size();</span><br><span class="line"> <span class="keyword">for</span> (j=<span class="number">0</span>; j&lt;NUMA &amp;&amp; canQuit; j++) &#123;</span><br><span class="line">    HistoryRecord r = (HistoryRecord)app.activities.get(j);</span><br><span class="line">    canQuit = (r.haveState || !r.stateNotNeeded)</span><br><span class="line">            &amp;&amp; !r.visible &amp;&amp; r.stopped;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (canQuit) &#123;</span><br><span class="line">    <span class="comment">// Finish all of the activities, and then the app itself.</span></span><br><span class="line">    <span class="keyword">for</span> (j=<span class="number">0</span>; j&lt;NUMA; j++) &#123;</span><br><span class="line">        HistoryRecord r = (HistoryRecord)app.activities.get(j);</span><br><span class="line">        <span class="keyword">if</span> (!r.finishing) &#123;</span><br><span class="line">            destroyActivityLocked(r, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        r.resultTo = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (app.pid &gt; <span class="number">0</span> &amp;&amp; app.pid != MY_PID) &#123;</span><br><span class="line">        Process.killProcess(app.pid);</span><br><span class="line">    &#125;</span><br><span class="line">    cleanUpApplicationRecordLocked(app, <span class="keyword">false</span>, i);</span><br><span class="line">    i--;</span><br><span class="line">    <span class="comment">//dump();</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">// 回收条件代码</span></span><br><span class="line"><span class="comment">//Finally, if there are too many activities now running, try to</span></span><br><span class="line"><span class="comment">//finish as many as we can to get back down to the limit.</span></span><br><span class="line"> <span class="keyword">for</span> ( i=<span class="number">0</span>; i&lt;mLRUActivities.size() &amp;&amp; mLRUActivities.size()  &gt; curMaxActivities; i++) &#123;</span><br><span class="line">   <span class="keyword">final</span> HistoryRecord r = (HistoryRecord)mLRUActivities.get(i);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We can finish this one if we have its icicle saved and</span></span><br><span class="line">    <span class="comment">// it is not persistent.</span></span><br><span class="line">    <span class="keyword">if</span> ((r.haveState || !r.stateNotNeeded) &amp;&amp; !r.visible</span><br><span class="line">         &amp;&amp; r.stopped &amp;&amp; !r.persistent &amp;&amp; !r.finishing) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> origSize = mLRUActivities.size();</span><br><span class="line">        destroyActivityLocked(r, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (origSize  &gt; mLRUActivities.size()) &#123;</span><br><span class="line">            i--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Linux_内核中的内存回收">Linux 内核中的内存回收</h3><h4 id="lowmemorykiller">lowmemorykiller</h4><p>上面提到，trimApplications() 函数中会执行一个叫做 updateOomAdjLocked() 的函数，如果返回 false，则执行默认回收，若返回 true 则不执行默认内存回收。updateOomAdjLocked 将针对每一个进程更新一个名为 adj 的变量，并将其告知 Linux 内核，内核维护一个包含 adj 的数据结构（即进程表），并通过 lowmemorykiller 检查系统内存的使用情况，在内存不足的情况下杀死一些进程并释放内存。下面将对这种 Android Framework 与 Linux 内核相配合的内存回收机制进行研究。</p>
<p>由于 Android 操作系统中的所有应用程序都运行在独立的 Dalvik 虚拟机环境中，Linux 内核无法获知每个进程的运行状态，也就无法为每个进程维护一个合适的 adj 值，因此，Android Application Framework 中必须提供一套机制以动态的更新每个进程的 adj。这就是 updateOomAdjLocked()。</p>
<p>updateOomAdjLocked() 位于 ActivityManagerService 中，其主要作用是为进程选择一个合适的 adj 值，并通知 Linux 内核更新这个值。updateOomAdjLocked 首先调用 computeOomAdjLocked() 初步计算 adj 的值，然后回到 updateOomAdjLocked() 对其值进行进一步修正。估算流程可参见代码。</p>
<p>关于 adj，其定义在 task_struct-&gt;signal_struct-&gt;adj, 文件 /kernel/include/linux/sched.h 中。实质为进程数据结构中的一个变量，用来表示发生 Out of Memory 时杀死进程的优先级顺序。lowmemorykiller 利用这个变量对进程的重要程度进行判断，并在内存不足时释放部分空间，其实现在文件 /kernel/drivers/staging/android/lowmemorykiller.c 中。lowmemorykiller 定义了两个数组：lowmem_adj 和 lowmem_minfree。其中 lowmen_adj 定义了一系列 adj 键值，而 lowmem_minfree 的每个元素代表一个内存阈值。如下代码中四个阈值分别是 6MB，8MB，16MB 和 64MB，分别代表当内存小于 64MB 时，adj 大于或等于 12 的那些进程将被杀死并回收，内存小于 16MB 时，adj 大于等于 6 的那些进程将被杀死并回收，内存小于 8MB 时，adj 大于等于 1 的那些进程将被杀死并回收，内存小于 6MB 时，adj 大于等于 0 的所有进程将被杀死并回收。内核中的每个进程都持有一个 adj，取值范围 -17 到 15，值越小代表进程的重要性越高，回收优先级越低，其中 -17 代表禁用自动回收。Android 系统中，只有 0-15 被使用。</p>
<p>lowmemorykiller 注册一个 lowmem_shrinker，lowmem_shrinker 利用了标准 Linux 内核中的 Cache Shrinker 来实现，当空闲内存页面不足时，内核线程 kswapd 将用已注册的 lowmem_shrinker 来回收内存页面。</p>
<p>lowmem_shrink 的代码在函数 lowmem_shrink 中，下面给出该函数的主要结构。lowmem_shrink 根据上述规则遍历所有进程，选出需要结束的进程，通过发送一个无法忽略的信号 SIGKILL 强制结束这些进程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lowmem_shrink</span><span class="params">(<span class="keyword">struct</span> shrinker *s, <span class="keyword">int</span> nr_to_scan, gfp_t gfp_mask)</span></span><br><span class="line"> </span>&#123;</span><br><span class="line">        for_each_process(p) &#123;</span><br><span class="line">           <span class="comment">//Select processes to be forced</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (selected) &#123;</span><br><span class="line">               force_sig(SIGKILL, selected);</span><br><span class="line">               rem -= selected_tasksize;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">        rem = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> rem;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="Oom_killer">Oom_killer</h4><p>如果上述各种方法都无法释放出足够的内存空间，那么当为新的进程分配应用程序时将发生 Out of Memory 异常，OOM_killer 将尽最后的努力杀掉一些进程来释放空间。Android 中的 OOM_killer 继承自标准 Linux 2.6 内核，用于分配内存时 Out of Memory 的处理。Android 并没有对其实现方式进行修改。其位置在 linux/mm/oom_kill.c。 oom_killer 遍历进程，并计算所有进程的 badness 值，选择 badness 最大的那个进程将其杀掉。函数 badness 的声明如下：</p>
<p>unsigned long badness(struct task_struct *p, unsigned long uptime) 函数 select_bad_process 返回将要杀掉的那个进程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> task_struct *select_bad_process(<span class="keyword">unsigned</span> <span class="keyword">long</span> *ppoints, <span class="keyword">struct</span> mem_cgroup *mem)</span><br><span class="line">&#123;</span><br><span class="line">       for_each_process(p) &#123;</span><br><span class="line">              points = badness(p, uptime.tv_sec);</span><br><span class="line">              <span class="keyword">if</span> (points &gt; *ppoints || !chosen) &#123;</span><br><span class="line">                      chosen = p;</span><br><span class="line">                      *ppoints = points;</span><br><span class="line">              &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> chosen;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，和 lowmemorykiller 一样，通过发送 SIGKILL 结束选中的进程。由于 oom_killer 与标准 Linux 内核并无不同，这里不再详细研究。</p>

          
        
      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Android/">
                #Android
              </a>
            
              <a href="/tags/内存机制/">
                #内存机制
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/22/android-basic-02/">
                Android 开发之基础知识（02）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          
            发表于 2015-03-22
          
        </span>

        
          
            <span class="post-category">
              &nbsp; | &nbsp; 分类于
              
                <a href="/categories/Android/">Android</a>

                
                

              
            </span>
          
        

        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          
            <blockquote>
<p>Activity 和 Fragment 的生命周期 + Android 在横竖屏切换时到底发生了什么？ + Android 线程和 Handler 基础入门</p>
</blockquote>
<h3 id="Activity_和_Fragment_的生命周期">Activity 和 Fragment 的生命周期</h3><p><img src="http://7xi7e6.com1.z0.glb.clouddn.com/activity_lifecycle_1.png" alt="Activity生命周期1"><br><img src="http://7xi7e6.com1.z0.glb.clouddn.com/activity_lifecycle_2.png" alt="Activity生命周期2"><br><img src="http://7xi7e6.com1.z0.glb.clouddn.com/activity_lifecycle_3.png" alt="Activity生命周期3"><br><img src="http://7xi7e6.com1.z0.glb.clouddn.com/activity-fragment_lifecycle_4.png" alt="Activity和Fragment生命周期4"></p>
<p>节选自：《Android in Action》, 《Professional Android, 4th》 …</p>
<hr>
<h3 id="Android在横竖屏切换时到底发生了什么？">Android在横竖屏切换时到底发生了什么？</h3><h4 id="基于orientation_changes">基于orientation changes</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    Log.d(<span class="string">"Square"</span>, <span class="string">"onCreate()"</span>);</span><br><span class="line">    <span class="keyword">if</span> (savedInstanceState == <span class="keyword">null</span>) &#123;</span><br><span class="line">      Log.d(<span class="string">"Square"</span>, <span class="string">"Requesting orientation change"</span>);</span><br><span class="line">      setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line">    Log.d(<span class="string">"Square"</span>, <span class="string">"onResume()"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onPause();</span><br><span class="line">    Log.d(<span class="string">"Square"</span>, <span class="string">"onPause()"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    Log.d(<span class="string">"Square"</span>, <span class="string">"onDestroy()"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>其运行情况如下：</p>
<ol>
<li>onCreate()</li>
<li>Requesting orientation change</li>
<li>onResume()</li>
<li>onPause()</li>
<li>onDestroy()</li>
<li>onCreate()</li>
<li>onResume()</li>
</ol>
</blockquote>
<h4 id="Orientation_changes_和Android主线程">Orientation changes 和Android主线程</h4><p>反射读取主线程消息队列里面内容的spy代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainLooperSpy</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Field messagesField;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Field nextField;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> MessageQueue mainMessageQueue;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MainLooperSpy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Field queueField = Looper.class.getDeclaredField(<span class="string">"mQueue"</span>);</span><br><span class="line">      queueField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      messagesField = MessageQueue.class.getDeclaredField(<span class="string">"mMessages"</span>);</span><br><span class="line">      messagesField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      nextField = Message.class.getDeclaredField(<span class="string">"next"</span>);</span><br><span class="line">      nextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      Looper mainLooper = Looper.getMainLooper();</span><br><span class="line">      mainMessageQueue = (MessageQueue) queueField.get(mainLooper);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dumpQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Message nextMessage = (Message) messagesField.get(mainMessageQueue);</span><br><span class="line">      Log.d(<span class="string">"MainLooperSpy"</span>, <span class="string">"Begin dumping queue"</span>);</span><br><span class="line">      dumpMessages(nextMessage);</span><br><span class="line">      Log.d(<span class="string">"MainLooperSpy"</span>, <span class="string">"End dumping queue"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dumpMessages</span><span class="params">(Message message)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (message != <span class="keyword">null</span>) &#123;</span><br><span class="line">      Log.d(<span class="string">"MainLooperSpy"</span>, message.toString());</span><br><span class="line">      Message next = (Message) nextField.get(message);</span><br><span class="line">      dumpMessages(next);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>记录orientation change发生之后消息队列里面的内容：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> MainLooperSpy mainLooperSpy = <span class="keyword">new</span> MainLooperSpy();</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    Log.d(<span class="string">"Square"</span>, <span class="string">"onCreate()"</span>);</span><br><span class="line">    <span class="keyword">if</span> (savedInstanceState == <span class="keyword">null</span>) &#123;</span><br><span class="line">      Log.d(<span class="string">"Square"</span>, <span class="string">"Requesting orientation change"</span>);</span><br><span class="line">      setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE);</span><br><span class="line">      mainLooperSpy.dumpQueue();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 输出：</span><br><span class="line"> * onCreate()</span><br><span class="line"> * Requesting orientation change</span><br><span class="line"> * Begin dumping queue</span><br><span class="line"> * &#123; what=118 when=-94ms obj=&#123;1.0 208mcc15mnc en_US ldltr sw360dp w598dp h335dp 320dpi nrml land finger -keyb/v/h -nav/h s.44?spn&#125; &#125;</span><br><span class="line"> * &#123; what=126 when=-32ms obj=ActivityRecord&#123;41fd2b48 token=android.os.BinderProxy@41fcce50 no component name&#125; &#125;</span><br><span class="line"> * End dumping queue</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONFIGURATION_CHANGED   = <span class="number">118</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RELAUNCH_ACTIVITY       = <span class="number">126</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>当Activity第一次启动的时候，主线程的消息队列是空的。</li>
<li>当前要执行的消息就是 LAUNCH_ACTIVITY，即创建一个Activity实例，先后调用 onCreate() 方法和 onResume() 方法。接下来主线程的looper才能处理消息队列里面下一个消息。</li>
</ul>
<blockquote>
<p>如果你真的需要使用handler.post()还要保持Activity引用</p>
<ul>
<li>在 Activity 的 onPause()方法里面通过 handler.removeCallbacks() 方法从消息队列移除这个消息。</li>
</ul>
</blockquote>
<h4 id="关于runOnUiThread()的一些话">关于runOnUiThread()的一些话</h4><p>不像 handler.post(), runOnUiThread() 在当前线程为主线程的情况下是不会发送这个runnable的，它会同步地调用 run() 方法。</p>
<h4 id="IntentService">IntentService</h4><p>在它内部，使用了一个 Looper 在一个专用 HandlerThread 的来处理这些Intents。当这个service 被销毁的时候，这个Looper会让你结束当前intent的处理，然后终结这个后台线程。</p>
<p>文章转载：<a href="http://android.jobbole.com/80638/" target="_blank" rel="external">Android在横竖屏切换时到底发生了什么？</a></p>

          
        
      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Android/">
                #Android
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/22/android-basic-01/">
                Android 开发之基础知识（01）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          
            发表于 2015-03-22
          
        </span>

        
          
            <span class="post-category">
              &nbsp; | &nbsp; 分类于
              
                <a href="/categories/Android/">Android</a>

                
                

              
            </span>
          
        

        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          
            <blockquote>
<p>Android 启动简史 + Android 的进程与线程 + Android Package Manager和Package Installer</p>
</blockquote>
<hr>
<h3 id="Android_启动简史">Android 启动简史</h3><blockquote>
<p>当按下Android设备电源键时究竟发生了什么？</p>
</blockquote>
<ul>
<li>启动过程是怎么样的？</li>
<li>什么是Linux内核？</li>
<li>桌面系统linux内核与Android系统linux内核有什么区别？</li>
<li>什么是引导装载程序？</li>
<li>什么是Zygote？</li>
<li>什么是X86以及ARM linux？</li>
<li>什么是init.rc?</li>
<li>什么是系统服务？</li>
</ul>
<p><img src="http://7xi7e6.com1.z0.glb.clouddn.com/android_boot_internal.png" alt="android 启动"></p>
<ol>
<li>启动电源以及系统启动</li>
<li>引导程序（\bootable\bootloader\legacy\usbloader）</li>
<li>内核</li>
<li>init进程（挂载目录 + 运行init.rc脚本）<ul>
<li>init进程可以在/system/core/init找到。</li>
<li>init.rc文件可以在/system/core/rootdir/init.rc（有特定的格式以及规则）找到。</li>
<li>readme.txt可以在/system/core/init/readme.txt找到。</li>
</ul>
</li>
<li>Zygote加载进程（/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java）</li>
<li>系统服务或服务（系统服务可以认为是一个进程。同一个系统服务在Android SDK可以以System Services形式获得）</li>
</ol>
<blockquote>
<p>核心服务：</p>
<ul>
<li>启动电源管理器</li>
<li>创建Activity管理器</li>
<li>启动电话注册</li>
<li>启动包管理器</li>
<li>设置Activity管理服务为系统进程</li>
<li>启动上下文管理器</li>
<li>启动系统Context Providers</li>
<li>启动电池服务</li>
<li>启动定时管理器</li>
<li>启动传感服务</li>
<li>启动窗口管理器</li>
<li>启动蓝牙服务</li>
<li>启动挂载服务</li>
</ul>
</blockquote>
<p><strong>一旦系统服务在内存中跑起来后，Android就完成了引导过程。<br>这个时候“ACTION_BOOT_COMPLETED”开机启动广播就会发出去。</strong></p>
<p>原文转载：<a href="http://android.jobbole.com/67931/" target="_blank" rel="external">《Android启动过程深入解析》</a></p>
<hr>
<h3 id="Android_的进程与线程">Android 的进程与线程</h3><p>当一个 Android 应用程序组件启动的时候，如果此时这个程序的其他组件没有正在运行，那么系统会为这个程序以单一线程的形式启动一个新的 Linux 进程。<br>默认情况下，同一应用程序下的所有组件都运行再相同的进程和线程（一般称为程序的“主”线程）中。<br>如果一个应用组件启动但这个应用的进程已经存在了，那么这个组件将会在这个进程中启动，同时在这个应用的主线程里面执行。然而，你也可以让你的应用里面的组件运行在不同的进程里面，也可以为任何进程添加额外的线程。</p>
<h4 id="进程">进程</h4><ul>
<li>默认情况下，同一程序的所有组件都运行在相同的进程里面。</li>
<li>Manifest 文件里面为每一个组件元素：<strong>activity</strong>, <strong>service</strong>, <strong>receiver</strong> 和 <strong>provider</strong> 提供了 <strong>android:process</strong> 属性，通过设置这个属性你可以让组件运行在特定的进程中。</li>
<li><strong>application</strong> 元素也支持 <strong>android:process</strong> 属性，设置这个属性可以让这个应用里面的所有组件都默认继承这个属性。</li>
</ul>
<blockquote>
<p>Android 可能在系统剩余内存较少，而其他直接服务用户的进程又要申请内存的时候shut down 一个进程， 这时这个进程里面的组件也会依次被kill掉。当这些组件有新的任务到达时，他们对应的进程又会被启动。<br>在决定哪些进程需要被kill的时候，Android系统会权衡这些进程跟用户相关的重要性。</p>
</blockquote>
<h5 id="进程的生命周期">进程的生命周期</h5><p>重要性层级:</p>
<ol>
<li>Foreground 进程 : 一个正在和用户进行交互的进程。 如果一个进程处于下面的状态之一，该进程即为 foreground 进程<ul>
<li>进程包含了一个与用户交互的 Activity ( onResume() 方法被调用)。</li>
<li>进程包含了一个绑定了与用户交互的activity的 Service 。</li>
<li>进程包含了一个运行在”in the foreground”状态的 Service（ startForeground() 方法被调用 ）。</li>
<li>进程包含了一个正在运行的它的生命周期回调函数 (onCreate(), onStart(), oronDestroy())的 Service 。</li>
<li>进程包含了一个正在运行 onReceive() 方法的 BroadcastReceiver 。</li>
</ul>
</li>
<li>Visible 进程 : 一个进程没有任何 foreground 组件, 但是它还能影响屏幕上的显示。<ul>
<li>进程包含了一个没有在 foreground 状态的 Activity ，但是它仍然被用户可见 ( onPause() 方法已经被调用)。这种情况是有可能出现的。比如，一个 activity 启动了一个 dialog，这样就会让之前的 activity 在dialog的后面部分可见。</li>
<li>进程包含了一个绑定在一个visible（或者 foreground）activity的 Service 。</li>
</ul>
</li>
<li>Service 进程 : 一个包含着已经以 startService() 方法启动的 Service 的进程，同时还没有进入上面两种更高级别的种类。</li>
<li>Background 进程 一个包含了已不可见的 activity 的进程 ( onStop() 已经被调用)。</li>
<li>Empty 进程 : 一个不包含任何活动的应用组件的进程。 这种进程存在的唯一理由就是缓存。为了提高一个组件的启动的时间需要让组件在这种进程里运行。</li>
</ol>
<blockquote>
<p>因为进程里面运行着一个 service 的评级要比一个包含background activities的进程要高，所以当一个 activity 启动长时操作时，最好启动一个 service 来做这个操作，而不是简单的创建一个worker线程—特别是当这个长时操作可能会拖垮这个activity。比如，一个需要上传图片到一个网站的activity 应当开启一个来执行这个上传操作。这样的话，即使用户离开来这个activity也能保证上传动作在后台继续。使用 service 可以保证操作至少处于”service process” 这个优先级，无论这个activity发生了什么。这也是为什么 broadcast receivers 应该使用 services 而不是简单的将耗时的操作放到线程里面。</p>
</blockquote>
<h4 id="线程">线程</h4><p>关于Android单线程模型的规则：</p>
<ol>
<li>不要阻塞 UI 线程</li>
<li>不要在非UI线程里访问 Android UI toolkit</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 违反第2条规则</span></span><br><span class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            Bitmap b = loadImageFromNetwork(<span class="string">"http://example.com/image.png"</span>);</span><br><span class="line">            mImageView.setImageBitmap(b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Activity.runOnUiThread(Runnable)</li>
<li>View.post(Runnable)</li>
<li>View.postDelayed(Runnable, long)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 随着操作复杂性的增长，代码会变得越来越复杂，越来越难维护</span></span><br><span class="line"><span class="comment">// 解决： 使用 Handler 或 AsyncTask</span></span><br><span class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Bitmap bitmap = loadImageFromNetwork(<span class="string">"http://example.com/image.png"</span>);</span><br><span class="line">            mImageView.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    mImageView.setImageBitmap(bitmap);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br></pre></td></tr></table></figure>
<p>原文转载：<a href="http://android.jobbole.com/80640/" target="_blank" rel="external">《Android的进程与线程》 </a></p>
<hr>
<h3 id="Android_的_Package_Manager">Android 的 Package Manager</h3><ul>
<li>什么是Package Manager（包管理器）和Package Installer（程序安装包）？</li>
<li>APK文件保存在Android的哪个地方？</li>
<li>APK文件安装过程的细节是怎样的？</li>
<li>Package Manager（包管理器）是怎样保存数据的？</li>
<li>应该去哪里找Package Manager和Package Installer的源码？</li>
</ul>
<h4 id="什么是Package_Manager和Package_Installer">什么是Package Manager和Package Installer</h4><p>PackageInstaller是安卓上默认的应用程序，用它来交互式地安装普通包文件。<br>PackageInstaller提供了用户界面来管理应用或者包文件。<br>PackageInstaller调用一个叫InstallAppProgress的activity来获取用户发出的指令。InstallAppProgress会请求Package Manager服务，然后通过installd来安装包文件。源码提供在/packages/apps/PackageInstaller上。</p>
<p>Package Manger是一个实际上管理应用程序安装、卸载和升级的API。<br>当我们安装APK文件时，Package Manager会解析APK包文件和显示确认信息。<br>当我们点击OK按钮后，Package Manger会调用一个叫“InstallPackage”的方法，这个方法有四个参数，也就是uri、installFlags、observer和installPackagename。Package Manger会启动一个叫“package”的service（服务），现在所有模糊的东西会发生在这个service中。</p>
<p><strong>Package Manger服务运行在系统服务进程中，而安装守护程序（installd）作为一个本地进程运行着，他们都在系统启动时开始运行。</strong></p>
<h4 id="APK文件保存在Android的哪个地方？">APK文件保存在Android的哪个地方？</h4><ul>
<li>预装程序（即相机，日历和浏览器等）保存在/system/app/中。</li>
<li>用户安装程序（APIDemo，Any.do等）保存在/data/app/中。</li>
<li>目录/data/data/ 则来保存数据库、shared preference、本地函数库和缓存数据。</li>
</ul>
<h4 id="APK文件安装过程的细节是怎样的？">APK文件安装过程的细节是怎样的？</h4><p>下面的过程执行在Package Manger服务中。</p>
<ul>
<li>等待；</li>
<li>添加一个包文件到安装进程的队列中；</li>
<li>确定合适的地方来安装包文件；</li>
<li>复制apk文件到一个给定的目录下；</li>
<li>确定应用的UID；</li>
<li>请求installd守护程序进程；</li>
<li>创建应用目录和设置权限；</li>
<li>提取dex代码到缓存目录中；</li>
<li>解析packages.list、system、data和packages.xml的最新状态；</li>
<li>向系统发送广播消息，消息带有安装完成效果的名字Intent.ACTION_PACKAGE_ADDED：如果是更新，会带有新的（Intent.ACTION_PACKAGE_REPLACED）。</li>
</ul>
<h4 id="Package_Manager(包管理器)是怎样保存数据的？">Package Manager(包管理器)是怎样保存数据的？</h4><p>Package Manager保存应用程序的信息在/data/system目录下的三个文件里。</p>
<ul>
<li>packages.xml：这个文件包含所有的权限和Packages/Applications。</li>
<li>packages.list： 这是一个简单的文本文件，包含了包名、用户id、flag和数据目录</li>
<li>packages-stoped.xml：这个文件包含了已经是停止状态的包的列表，停止状态的应用是不能接收任何的广播的。</li>
</ul>
<h4 id="去哪里可以找到Package_Manager和Package_Installer的源码？">去哪里可以找到Package Manager和Package Installer的源码？</h4><p><strong>Package Manger</strong></p>
<blockquote>
<p>frameworks/base/services/java/com/android/server/pm/Settings.java<br>frameworks/base/services/java/com/android/server/pm/PackageManagerService.java<br>frameworks/base/services/java/com/android/server/pm/IPackageManager.aidl<br>frameworks/base/services/java/com/android/server/pm/PackageSignatures.java<br>frameworks/base/services/java/com/android/server/pm/PreferredActivity.java<br>frameworks/services/java/com/android/server/PreferredComponent.java<br>frameworks/core/java/android/content/IntentFilter.java<br>frameworks/base/core/java/android/content/pm/PackageParser.java<br>frameworks/base/services/java/com/android/server/pm/Installer.java<br>frameworks/base/core/java/com/android/internal/app/IMediaContainerService.aidl<br>frameworks/base/packages/DefaultContainerService/src/com/android/defcontainer/DefaultContainerService.java</p>
</blockquote>
<p><strong>Package Installer</strong></p>
<blockquote>
<p>packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageInstallerActivity.java<br>packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageUtil.java<br>packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallAppProgress.java</p>
</blockquote>
<p>原文转载: <a href="http://android.jobbole.com/67286/" target="_blank" rel="external">深入安卓Package Manager和Package Installer</a></p>

          
        
      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Android/">
                #Android
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/22/android-ui-screen-adapter/">
                Android UI 之开发适配
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          
            发表于 2015-03-22
          
        </span>

        
          
            <span class="post-category">
              &nbsp; | &nbsp; 分类于
              
                <a href="/categories/Android/">Android</a>

                
                

              
            </span>
          
        

        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          
            <h3 id="Android_3-2_(API_Level_13)_起">Android 3.2 (API Level 13) 起</h3><ul>
<li>resource-small: Screen measuring at least 426dp×320dp</li>
<li>resource-medium: Screen measuring at least 470dp×320dp</li>
<li>resource-large: Screen measuring at least 640dp×480dp</li>
<li>resource-xlarge: Screen measuring at least 960dp×720dp</li>
</ul>
<p><img src="http://7xi7e6.com1.z0.glb.clouddn.com/android_design_experience_3.jpg" alt="索引3"></p>
<ul>
<li>(resource-sw___dp): A 640dp×480dp screen always has a smallest width of 480dp.</li>
<li>(resource-w___dp): A 640dp×480dp screen has a width of 640dp when in landscape and 480dp when in portrait.</li>
<li>(resource-h___dp): A 640dp×480dp screen has a height of 640dp when in portrait and 480dp when in landscape.</li>
</ul>
<h3 id="Layout_Aliases">Layout Aliases</h3><ul>
<li>res/values-xlarge/layout.xml</li>
<li>R.layout.main</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">resources</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">item</span> <span class="attribute">name</span>=<span class="value">"main"</span> <span class="attribute">type</span>=<span class="value">"layout"</span>&gt;</span>@layout/main_tablet<span class="tag">&lt;/<span class="title">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="Density">Density</h4><table>
<thead>
<tr>
<th>Density selector</th>
<th>Equals</th>
</tr>
</thead>
<tbody>
<tr>
<td>ldpi</td>
<td>160 dpi x 0.75</td>
</tr>
<tr>
<td>mdpi</td>
<td>160 dpi</td>
</tr>
<tr>
<td>hdpi</td>
<td>1.5 x 160 dpi = 240 dpi</td>
</tr>
<tr>
<td>xhdpi</td>
<td>2 x 160 dpi = 320 dpi</td>
</tr>
<tr>
<td>xxhdpi</td>
<td>3 x 160 dpi = 480 dpi</td>
</tr>
<tr>
<td>xxxhdpi</td>
<td>4 x 160 dpi = 640 dpi</td>
</tr>
</tbody>
</table>
<h4 id="Icon_Size">Icon Size</h4><table>
<thead>
<tr>
<th>Icons</th>
<th>mdpi</th>
<th>hdpi</th>
<th>xhdpi</th>
<th>xxhdpi</th>
<th>xxxhdpi</th>
</tr>
</thead>
<tbody>
<tr>
<td>Launcher</td>
<td>48px</td>
<td>72px</td>
<td>96px</td>
<td>144px</td>
<td>192px</td>
</tr>
<tr>
<td>Action bar</td>
<td>32px</td>
<td>48px</td>
<td>64px</td>
<td>96px</td>
<td>128px</td>
</tr>
<tr>
<td>Notification bar</td>
<td>24px</td>
<td>36px</td>
<td>48px</td>
<td>72px</td>
<td>96px</td>
</tr>
</tbody>
</table>
<h4 id="dp_转换为_px">dp 转换为 px</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">convertToPixelFromDp</span><span class="params">(<span class="keyword">int</span> dpInput)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The density for the current device</span></span><br><span class="line">  <span class="comment">// getResources().getConfiguration().densityDpi;</span></span><br><span class="line">  <span class="comment">// get the screen's density scale</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">float</span> scale = getResources().getDisplayMetrics().density;</span><br><span class="line">  <span class="comment">// convert the dps to pixels, based on density scale</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>) (dpInput * scale + <span class="number">0.5f</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="设计经验索引">设计经验索引</h3><p><img src="http://7xi7e6.com1.z0.glb.clouddn.com/android_design_experience_1.jpg" alt="索引1"><br><img src="http://7xi7e6.com1.z0.glb.clouddn.com/android_design_experience_2.jpg" alt="索引2"></p>

          
        
      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Android/">
                #Android
              </a>
            
              <a href="/tags/UI/">
                #UI
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/22/android-project-build-with-gradle-speedup/">
                加速 Android 工程构建之 Gradle
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          
            发表于 2015-03-22
          
        </span>

        
          
            <span class="post-category">
              &nbsp; | &nbsp; 分类于
              
                <a href="/categories/Android/">Android</a>

                
                

              
            </span>
          
        

        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          
            <h3 id="开启gradle单独的守护进程">开启gradle单独的守护进程</h3><p>在下面的目录下面创建gradle.properties文件：</p>
<ul>
<li>/home/<username>/.gradle/ (Linux)</username></li>
<li>/Users/<username>/.gradle/ (Mac)</username></li>
<li>C:\Users\<username>.gradle (Windows)</username></li>
</ul>
<p>并在文件中增加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.gradle.daemon=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>同时修改项目下的gradle.properties文件也可以优化：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Project-wide Gradle settings.</span></span><br><span class="line"><span class="comment"># IDE (e.g. Android Studio) users:</span></span><br><span class="line"><span class="comment"># Settings specified in this file will override any Gradle settings</span></span><br><span class="line"><span class="comment"># configured through the IDE.</span></span><br><span class="line"><span class="comment"># For more details on how to configure your build environment visit</span></span><br><span class="line"><span class="comment"># http://www.gradle.org/docs/current/userguide/build_environment.html</span></span><br><span class="line"><span class="comment"># The Gradle daemon aims to improve the startup and execution time of Gradle.</span></span><br><span class="line"><span class="comment"># When set to true the Gradle daemon is to run the build.</span></span><br><span class="line"><span class="comment"># TODO: disable daemon on CI, since builds should be clean and reliable on servers</span></span><br><span class="line">org.gradle.daemon=<span class="literal">true</span></span><br><span class="line"><span class="comment"># Specifies the JVM arguments used for the daemon process.</span></span><br><span class="line"><span class="comment"># The setting is particularly useful for tweaking memory settings.</span></span><br><span class="line"><span class="comment"># Default value: -Xmx10248m -XX:MaxPermSize=256m</span></span><br><span class="line">org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=<span class="number">512</span>m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-<span class="number">8</span></span><br><span class="line"><span class="comment"># When configured, Gradle will run in incubating parallel mode.</span></span><br><span class="line"><span class="comment"># This option should only be used with decoupled projects. More details, visit</span></span><br><span class="line"><span class="comment"># http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects</span></span><br><span class="line">org.gradle.parallel=<span class="literal">true</span></span><br><span class="line"><span class="comment"># Enables new incubating mode that makes Gradle selective when configuring projects. </span></span><br><span class="line"><span class="comment"># Only relevant projects are configured which results in faster builds for large multi-projects.</span></span><br><span class="line"><span class="comment"># http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:configuration_on_demand</span></span><br><span class="line">org.gradle.configureondemand=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>同时上面的这些参数也可以配置到前面的用户目录下的gradle.properties文件里，那样就不是针对一个项目生效，而是针对所有项目生效。</p>
<p>上面的配置文件主要就是做， 增大gradle运行的java虚拟机的大小，让gradle在编译的时候使用独立进程，让gradle可以平行的运行。</p>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<h3 id="修改android_studio配置">修改android studio配置</h3><p>在android studio的配置中，开启offline模式，以及修改配置。实际上的配置和上面的一大段一样，主要是在这个地方配置的只会在ide构建的时候生效，命令行构建不会生效。</p>
<p><img src="http://7xi7e6.com1.z0.glb.clouddn.com/0001_as_gradle_offline.png" alt="gradle offline config"><br><img src="http://7xi7e6.com1.z0.glb.clouddn.com/0002_as_gradle_config.png" alt="gradle compiler config"></p>
<h3 id="命令行构建">命令行构建</h3><p>基于上面的配置，命令行构建时在命令后面加上这个参数即可 —daemon —parallel —offline。</p>
<h3 id="引入依赖库时使用aar">引入依赖库时使用aar</h3><p>使用网上第三方的依赖库时尽量使用aar，可以在<a href="http://gradleplease.appspot.com/" target="_blank" rel="external">maven</a>或者<a href="https://github.com/Goddchen/mvn-repo" target="_blank" rel="external">github</a>搜索。</p>
<p>自己的库模块也可以打包成aar，关于这个可以参考<a href="http://www.stormzhang.com/android/2015/03/01/android-reference-local-aar/" target="_blank" rel="external">stormzhang</a>的文章。</p>
<p>转载出处: <a href="http://blog.isming.me/2015/03/18/android-build-speed-up/" target="_blank" rel="external">加速Android Studio/Gradle构建</a></p>

          
        
      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Android/">
                #Android
              </a>
            
              <a href="/tags/Gradle/">
                #Gradle
              </a>
            
          </div>
        

        

        
        
          <div class="post-eof"></div>
        
      </div>
    
  </div>


  

          </div>

          
            <div class="pagination">
              <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">&raquo;</a>
            </div>
          
        </div>

        
<div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>

<div id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    

    <div class="site-overview">
      <div class="site-author motion-element">
        <img class="site-author-image" src="/images/default_avatar.jpg" alt="mSolo Yu" />
        <p class="site-author-name">mSolo Yu</p>
      </div>
      <p class="site-description motion-element">关注切入点、产品、设计开发和敏捷实践</p>
      <div class="site-state motion-element">
        <div class="site-state-item site-state-posts">
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">日志</span>
        </div>
        <div class="site-state-item site-state-tags">
            <span class="site-state-item-count">6</span>
            <span class="site-state-item-name">标签</span>
        </div>
        <div class="site-state-item site-state-pages">
            <span class="site-state-item-count">2</span>
            <span class="site-state-item-name">页面</span>
        </div>
      </div>

      

      <div class="links-of-author motion-element">
        
      </div>

      
      

    </div>

    

  </div>
</div>


      </div>
    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">mSolo Yu</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $(".fancybox").fancybox();
    });
  </script>

  <script type="text/javascript">
  function hasMobileUA () {
    var nav = window.navigator;
    var ua = nav.userAgent;
    var pa = /iPad|iPhone|Android|Opera Mini|BlackBerry|webOS|UCWEB|Blazer|PSP|IEMobile|Symbian/g;

    return pa.test(ua);
  }

  function isDesktop () {
    return screen.width > 991 && !hasMobileUA();
  }

  function isTablet () {
    return screen.width < 992 && screen.width > 767 && hasMobileUA();
  }

  function isMobile () {
    return screen.width < 767 && hasMobileUA();
  }

  function escapeSelector (selector) {
    return selector.replace(/[!"$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&")
  }
</script>

  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" id="motion.global">
  $(document).ready(function () {
    var body = $('body');
    var isSidebarVisible = false;
    var sidebarToggle = $('.sidebar-toggle');
    var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
    var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
    var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
    var sidebar = $('.sidebar');

    var SIDEBAR_WIDTH = '320px';
    var SIDEBAR_DISPLAY_DURATION = 300;

    var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

    var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
    var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

    var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine2ndStatusArrow = {width: '90%'};
    var sidebarToogleLine2ndStatusClose = {opacity: 0};

    var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
    var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

    LogoAndMenuMotion();
    sidebatToggleMotion();
    postsListMotion();
    backToTopMotion();


    $(document)
      .on('sidebar.isShowing', function () {
        isDesktop() && body.velocity(
          {paddingRight: SIDEBAR_WIDTH},
          SIDEBAR_DISPLAY_DURATION
        );
        sidebarContentMotion();
      })
      .on('sidebar.isHiding', function () {});

    function LogoAndMenuMotion() {
      $.Velocity.RunSequence([
        { e: $('.brand'), p: { opacity: 1 }, o: { duration: 100 } },
        { e: $('.logo'), p: { opacity: 1, top: 0 }, o: { duration: 50} },
        
        { e: $('.site-title'), p: { opacity: 1, top: 0 }, o: { duration: 200 } }
      ]);
      $('.menu-item').velocity('transition.slideDownIn', {display: null});
    }


    function backToTopMotion () {
      var b2top = $('.back-to-top');
      b2top.on('click', function () {
        body.velocity('scroll');
      });
    }

    function sidebarShowMotion () {

      sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
      sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
      sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

      sidebar.velocity({width: SIDEBAR_WIDTH}, {
        display: 'block',
        duration: SIDEBAR_DISPLAY_DURATION,
        complete: function () {
          sidebar.addClass('sidebar-active');
          sidebar.trigger('sidebar.didShow');
        }
      });
      sidebar.trigger('sidebar.isShowing');
    }

    function sidebarHideMotion () {
      isDesktop() && body.velocity({paddingRight: 0});
      sidebar.velocity('reverse');

      sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
      sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
      sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);

      sidebar.removeClass('sidebar-active');
      sidebar.trigger('sidebar.isHiding');
    };

    function sidebarContentMotion () {
      $('.sidebar .motion-element').velocity(
        'transition.slideRightIn',
        {stagger: 50, drag: true}
      );
    }

    function postsListMotion () {
      var postMotionOptions = window.postMotionOptions || {stagger: 300, drag: true};
      $('.post').velocity('transition.slideDownIn', postMotionOptions);
    }

    function sidebatToggleMotion () {
      sidebarToggle.on('click', function () {
        isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
        isSidebarVisible = !isSidebarVisible;
      });

      sidebarToggle.hover(function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
      }, function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
      });
    }
  });

</script>





  

  

  
  

  


  
</body>
</html>
